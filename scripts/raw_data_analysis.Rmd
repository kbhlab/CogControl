---
title: "raw_data_analysis"
author: "Hilary Killam"
date: "January 27, 2020"
output: html_document
---
##Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

## Load packages
library(tidyverse)
library(readxl)
library(stringr)
library(tidyr)
library(ggplot2)
library(car)
library(ez)
library(snakecase)
library(janitor)
library(lme4)
library(effects)
library(emmeans)
library(apaTables)
library(here)
library(eyetrackingR)
library(patchwork)
options(scipen = 999)

kovacs09 <- "KovÃ¡cs & Mehler 2009"

## Define minimum looking and minimum trial numbers for this study
MIN_LOOK_PROPORTION <- .5
MIN_NUMBER_TRIALS <- 5

```

##Load Data

```{r load_data, include = FALSE}

###-----------------------------------------------------------LOAD DATA--------------------------------------------------------

load(here("data", "tobii_full_export.Rda")) #full export data is saved as RDA file since the csv is too large for GitHub

## Read in MSL data
ms_list <- read_csv(here("data", "2019_CogControl_MSL.csv"), na = "-") %>%
  separate(lang.group,into = c("language", "group")) %>%
  filter(keeper == 1) 
colnames(ms_list) <- to_snake_case(colnames(ms_list)) #make everything snake case so it's easier to remember variable names

```

##Clean Data

```{r clean_data, include = FALSE}

###--------------------------------------------------------PREP MSL DATA------------------------------------------------------

ms_list <- ms_list %>%  
  mutate(age_group = fct_rev(as.factor(age_group))) %>%
  mutate(language = fct_rev(as.factor(language))) %>%
  mutate(total_vocab_prod = as.numeric(total_vocab_prod)) %>%
  mutate(total_concept_prod = as.numeric(total_concept_prod)) %>%
  mutate(recording_name = as_factor(recording_name)) %>%
  mutate(gender = as.factor(gender))


###-----------------------------------------------------------------PREP TOBII DATA----------------------------------------------

  ###-------------------------------------------------------------------set factor levels:
trial_name_levels <- c("pre-switch_1", "pre-switch_2", "pre-switch_3", "pre-switch_4", "pre-switch_5", "pre-switch_6", "pre-switch_7", "pre-switch_8", "pre-switch_9", "post-switch_1", "post-switch_2", "post-switch_3", "post-switch_4", "post-switch_5", "post-switch_6", "post-switch_7", "post-switch_8", "post-switch_9")


data_tobii_cleaned <- tobii_full_export %>%
   #head(n = 2500) %>% # uncomment this line to test code changes on a subset of the full dataset since running the whole thing takes awhile
  select(StudioTestName, RecordingName, RecordingDuration, MediaName, RecordingTimestamp, StudioEvent, FixationIndex, GazeEventType, GazeEventDuration, `GazePointX (ADCSpx)`, `GazePointY (ADCSpx)`, ValidityLeft, ValidityRight) %>% # choose only needed columns
  mutate(RecordingName = case_when(RecordingName == "Cogcontrol20_S116_48375" ~ "CogControl20_S116_48375",
                                    RecordingName != "Cogcontrol20_S116_48375" ~ RecordingName)) %>% #fix typo from Tobii
  rename(gaze_point_X = `GazePointX (ADCSpx)`, gaze_point_y = `GazePointY (ADCSpx)`, timestamp = `RecordingTimestamp`, order = StudioTestName) %>% #fix names (newname = oldname)
  mutate(MediaName = gsub(".wmv", "", MediaName)) %>% # drops the .wmv part.
  mutate(trial_num = parse_number(MediaName)) %>% #get trial number
  mutate(trial_type = factor(case_when(str_detect(MediaName, "Training") ~ "pre-switch", #get trial type
                                 str_detect(MediaName, "Test") ~ "post-switch"), levels = c("pre-switch", "post-switch"))) %>% #get trial type
  mutate(trial_name = factor(str_c(trial_type, trial_num, sep = "_"), levels = trial_name_levels)) %>% #combine trial number and trial type into a trial name (for example, "post-switch_3"")
  mutate(trial_unique = as.factor(str_c(RecordingName, trial_name, sep = "_"))) %>% #get a trial identifier that is unique to each participant, trial number, and trial type
  filter(RecordingName != "test") %>% #gets rid of a "test" recording that somehow got exported
  mutate(MediaName = as.factor(MediaName)) %>%
  group_by(trial_unique) %>%
  mutate(trial_start = min(timestamp)) %>%
  mutate(trial_end = max(timestamp)) %>%
  mutate(trial_from_zero = timestamp - trial_start) %>% #make time stamps start from 0 for each trial
  ungroup() %>%
  filter(!is.na(ValidityLeft) & !is.na(ValidityRight)) %>% #gets rid of Movie Start and Movie End rows that duplicate some info and don't have meaningful validity data or gaze point info
  mutate(trackloss = case_when(is.na(gaze_point_X) ~ TRUE, #creates a trackloss column that will be used in the eyetrackingR functions
                                is.na(gaze_point_y) ~ TRUE,
                                ValidityLeft > 1 & ValidityRight > 1 ~ TRUE,
                                TRUE ~ FALSE)) %>%
  clean_names() %>% #makes everything snake case 
  ###-------------------------------------------------------------------make target aoi coordinates:
   mutate(aoi_target_x_left = case_when(order == "Order 1" & trial_type == "pre-switch" ~ 10,
                                        order == "Order 1" & trial_type == "post-switch" ~ 1260,
                                        order == "Order 2" & trial_type == "pre-switch" ~ 1260,
                                        order == "Order 2" & trial_type == "post-switch" ~ 10)) %>%
  mutate(aoi_target_x_length = case_when(!is.na(trial_type) ~ 645)) %>%
  mutate(aoi_target_x_right = aoi_target_x_left + aoi_target_x_length) %>%
  mutate(aoi_target_y_top = case_when(!is.na(trial_type) ~ 270)) %>%
  mutate(aoi_target_y_length = case_when(!is.na(trial_type) ~ 650)) %>%
  mutate(aoi_target_y_bottom = aoi_target_y_top + aoi_target_y_length) %>%
  ###-------------------------------------------------------------------make distractor aoi coordinates:
  mutate(aoi_distractor_x_left = case_when(order == "Order 1" & trial_type == "pre-switch" ~ 1260,
                                        order == "Order 1" & trial_type == "post-switch" ~ 10,
                                        order == "Order 2" & trial_type == "pre-switch" ~ 10,
                                        order == "Order 2" & trial_type == "post-switch" ~ 1260)) %>%
  mutate(aoi_distractor_x_length = case_when(!is.na(trial_type) ~ 645)) %>%
  mutate(aoi_distractor_x_right = aoi_distractor_x_left + aoi_distractor_x_length) %>%
  mutate(aoi_distractor_y_top = case_when(!is.na(trial_type) ~ 270)) %>%
  mutate(aoi_distractor_y_length = case_when(!is.na(trial_type) ~ 650)) %>%
  mutate(aoi_distractor_y_bottom = aoi_distractor_y_top + aoi_distractor_y_length) %>%
  ###-------------------------------------------------------------------make circle aoi coordinates:
  mutate(aoi_circle_x_left = case_when(!is.na(trial_type) ~ 758)) %>%
  mutate(aoi_circle_x_length = case_when(!is.na(trial_type) ~ 385)) %>%
  mutate(aoi_circle_x_right = case_when(!is.na(trial_type) ~ aoi_circle_x_left + aoi_circle_x_length)) %>%  
  mutate(aoi_circle_y_top = case_when(!is.na(trial_type) ~ 400)) %>%
  mutate(aoi_circle_y_length = case_when(!is.na(trial_type) ~ 385)) %>%
  mutate(aoi_circle_y_bottom = case_when(!is.na(trial_type) ~ aoi_circle_x_left + aoi_circle_x_length)) %>%  
  filter(!is.na(media_name)) %>% #remove lines with no media name
  filter(!is.na(trial_unique)) %>% #remove NA unique trials (gets rid of times outside our trial windows that aren't interesting to us)
  filter(is.na(studio_event)) %>% #get rid of MovieStart and MovieEnd lines since they have duplicate timestamps
  mutate(remove_row = case_when(timestamp == 66398 & trial_unique == "CogControl20_S01_42270_Test_Target_Right_4.wmv" & is.na(validity_left) ~ "remove",
                                timestamp == 85782 & trial_unique == "CogControl20_S01_42270_Test_Target_Right_7.wmv" & is.na(validity_left) ~ "remove",
                                timestamp == 35816 & trial_unique == "CogControl7_S24_44771_Training_Target_Left_7.wmv" & is.na(validity_left) ~ "remove",
                                TRUE ~ "keep"))%>% #this identifies 3 rows with duplicate timestamps, but inexplicably without the fixation gaze data, that prevent the eyetrackingR code from running correctly
  filter(remove_row == "keep") %>% #get rid of those 3 weird rows from above

  ###-------------------------------------------------------------------get AOI look per time point:
  mutate(target = case_when(gaze_point_x > aoi_target_x_left & gaze_point_x < aoi_target_x_right & gaze_point_y > aoi_target_y_top & gaze_point_y < aoi_target_y_bottom ~ 1,
                                 TRUE ~ 0)) %>% #looks to target
  mutate(distractor = case_when(gaze_point_x > aoi_distractor_x_left & gaze_point_x < aoi_distractor_x_right & gaze_point_y > aoi_distractor_y_top & gaze_point_y < aoi_distractor_y_bottom ~ 1,
                                 TRUE ~ 0)) %>% #looks to distractor
  mutate(circle = case_when(gaze_point_x > aoi_circle_x_left & gaze_point_x < aoi_circle_x_right & gaze_point_y > aoi_circle_y_top & gaze_point_y < aoi_circle_y_bottom ~ 1,
                                 TRUE ~ 0)) %>% #looks to circle
  mutate(look_any = case_when(target == 1 | distractor == 1 | circle == 1 ~ 1,
                              TRUE ~ 0)) #looks to either target, distractor, or circle


#save(data_tobii_cleaned, file = here("data", "data_tobii_cleaned.Rda"))

```
##Merge Data

```{r merge_Data, include = FALSE}


###--------------------------------------------------------------------GET ANTICIPATION PERIOD KEEPERS---------------------------

data_anticipation <- data_tobii_cleaned %>%
  filter(trial_from_zero >= 2150 & trial_from_zero <= 3150) %>% #filter to just the aniticpatory period, which is 150 ms after the offset of the 2000 ms cue, and lasts for 1000 ms
  group_by(trial_unique) %>%
  mutate(prop_fixations = mean(look_any)) %>%
  filter(prop_fixations >= MIN_LOOK_PROPORTION) %>% #removes trials where the child did not fixate on anything for at least 50% of the anticipation period
  group_by(recording_name, trial_type) %>% 
  mutate(num_good_trials = length(unique(trial_num))) %>%
  filter(num_good_trials >= MIN_NUMBER_TRIALS) %>% #removes babies who don't have the minimum number of trials 
  group_by(recording_name) %>%
  mutate(num_trial_types = length(unique(trial_type))) %>%
  filter(num_trial_types == 2) %>% #removes babies who don't have data in both trial types
  ungroup()

final_sample_ids <- data_anticipation %>% #used for creating data_full_trials object for plotting whole trial
  select(recording_name) %>%
  unique()

final_sample_mslist <- ms_list %>%
  inner_join(final_sample_ids, by = "recording_name") %>%
  group_by(age_group) %>%
  mutate(median_vocab = median(total_vocab_prod, na.rm = TRUE)) %>%
  mutate(vocab_group = ifelse(median_vocab > total_vocab_prod,
                              "Low", 
                              "High")) %>%
  ungroup() %>%
  mutate(vocab_group = factor(vocab_group, levels = c("Low", "High")))# this is the full time series data, but only for infants that made it through to the final anticipation-period sample. Will be used for ploting time series data of whole trial
  

###----------------------------------------------------------------------CREATE MERGED FULL DATA----------------------------------

data_full_trials <- inner_join(data_tobii_cleaned, final_sample_mslist, by = "recording_name") %>%
  mutate(recording_name = as.factor(recording_name))


```

##Descriptives

```{r descriptives, echo = FALSE}
###----------------------------------------------------------FINAL SAMPLE COUNTS PER GROUP--------------------------------------

data_full_trials %>%
  group_by(language, age_group) %>%
  summarize(count = length(unique(recording_name)),
            vocab_median = median(total_vocab_prod, na.rm = TRUE), #why is this different from the output below?
            vocab_mean = mean(total_vocab_prod, na.rm = TRUE),
            avg_age_days = mean(total_age_days_excel, na.rm = TRUE),
            prop_female = mean(gender == 1, na.rm = TRUE))

##-------------------------------VOCAB MEDIANS FOR MONO AND BILINGUALS - ORIGINALLY THIS WAS DONE ON MSL DATA BEFORE THE MERGE, SO NOT BASED ON FINAL SAMPLE
## WHEN BASED OFF MSL PRE-MERGE, ML MEDIAN WAS 66 AND BL MEDIAN WAS 78.5. AFTER MERGE, ML MEDIAN IS 74 (72??) AND BL MEDIAN IS 79 (ML HAVE HIGHER MEAN THOUGH)
final_sample_ids %>%
  inner_join(ms_list, by = "recording_name") %>%
  group_by(language, age_group) %>%
  summarize(vocab_median = median(total_vocab_prod, na.rm = TRUE),
            vocab_mean = mean(total_vocab_prod, na.rm = TRUE),
            avg_age_days = mean(total_age_days_excel, na.rm = TRUE),
            prop_female = mean(gender == 1, na.rm = TRUE))


###----------------------------------------------------------FINAL SAMPLE COUNTS PER VOCAB GROUP------------------------------

data_full_trials %>%
  filter(age_group == "20 months") %>%
  group_by(language, vocab_group) %>%
  summarize(count = length(unique(recording_name)),
            vocab_median = median(total_vocab_prod, na.rm = TRUE), 
            vocab_mean = mean(total_vocab_prod, na.rm = TRUE),
            avg_age_days = mean(total_age_days_excel, na.rm = TRUE),
            prop_female = mean(gender == 1, na.rm = TRUE))

```

##EyetrackingR Data

```{r eyetrackingR_data, echo = FALSE}

###--------------------------------------------------CREATE EYETRACKINGR DATA FOR FULL TRIAL PLOTS--------------------------------

data_eyetracking_full_trials <- make_eyetrackingr_data(data_full_trials, 
                                participant_column = "recording_name",
                                trial_column = "trial_name", 
                                time_column = "trial_from_zero",
                                trackloss_column = "trackloss",
                                aoi_columns = c('target', 'circle', 'distractor'), # this will calculate prop looking in relation to all AOIs, not just target vs distractor. When I remove circle from here, the plot gets very wonky (I guess because of dividing by 0 in some cases?)
                                treat_non_aoi_looks_as_missing = TRUE)

full_trial_window <- subset_by_window(data_eyetracking_full_trials,
                                     window_start_time = 0,
                                     window_end_time = 5000, rezero = TRUE, remove = TRUE)

data_time_series_full <- make_time_sequence_data(full_trial_window,
                                         time_bin_size = 200,
                                         predictor_columns = c("language", "age_group", "total_vocab_prod", "vocab_group", "trial_type", "trial_num"),
                                         aois = c("circle", "target", "distractor"))

###---------------------------------------------------CREATE EYETRACKINGR DATA FOR ANTICIPATION PERIOD PLOTS--------------------

data_eyetracking_antic_window <- subset_by_window(data_eyetracking_full_trials,
                                     window_start_time = 2150,
                                     window_end_time = 3150, rezero = TRUE, remove = TRUE)

trackloss <- trackloss_analysis(data = data_eyetracking_antic_window)

data_eyetracking_clean <- clean_by_trackloss(data = data_eyetracking_antic_window, trial_prop_thresh = .5) #this eliminates all data from trials with 50% or more trackloss (we merged the baby IDs back with the full data, so makes sense we will re-exclude some trials here)

data_time_series_antic <- make_time_sequence_data(data_eyetracking_clean,
                                         time_bin_size = 200,
                                         predictor_columns = c("language", "age_group", "total_vocab_prod", "vocab_group", "trial_type", "trial_num"),
                                         aois = c("circle", "target", "distractor"))

```
##Time Series Plots

```{r time_series_plots, echo = FALSE}

#-----------------------------------------------------------EyetrackingR Plots - not as flexible as ggplot so will try below with ggplot
# plot7_full_trial <- data_time_series %>%
#   filter(age_group == "7 months") %>%
#   plot(predictor_column = "trial_type")
# 
# plot7_full_trial
# 
# plot20_full_trial <- data_time_series %>%
#   filter(age_group == "20 months") %>%
#   plot(predictor_column = "trial_type")
# 
# plot20_full_trial

###----------------------------------------------------------------------PLOT FULL TRIALS-----------------------------------------
line_colors <- c("#D7D7D7", "#FF3366", "#04BDD8")

time_series_full_trial <- data_time_series_full %>%
  pivot_wider(names_from = AOI, values_from = Prop) %>%
  group_by(trial_type, language, age_group, Time, trial_num) %>%
  summarise(target = mean(target, na.rm=TRUE), 
            distractor = mean(distractor, na.rm=TRUE),
            circle = mean(circle, na.rm = TRUE))  %>%
  pivot_longer(cols = c(circle, target, distractor), names_to = "aoi", values_to = "prop_looking") %>%
  mutate(aoi = factor(aoi, levels = c("circle", "target", "distractor")))  %>%
  mutate(trial_labels = paste0("Trial ", trial_num)) %>%
  group_by(age_group) %>%
  nest() %>%
  #create nested data for easily plotting more than one of the same plot by a group
  mutate(plot = map2(data, age_group, ~ ggplot(data = .x, aes(x = Time, y = prop_looking, color = aoi, linetype = language)) + 
  geom_line() +
  scale_color_manual(values = line_colors) +
  facet_grid(trial_labels ~ trial_type) +
  annotate("rect", xmin = 2150, xmax = 3150, ymin = -Inf, ymax = Inf, fill = "red", alpha = 0.07) +
  annotate("text", x = 2650, y = 0.9, label = "Anticipation \n Period", size = 2.5, color = "#927774") +
  ggtitle(age_group) +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("Time from trial start (ms)")  +
  ylab("Proportion looking")))
  
plot_full_trial_7 <- time_series_full_trial$plot[[1]] 
plot_full_trial_20 <- time_series_full_trial$plot[[2]]

# ggsave("plot_full_trial_7.png", path = here("figures"), plot = time_series_full_trial$plot[[1]], device = "png", width = 15, height = 10, units = "in",
#   dpi = 300)
 
# ggsave("plot_full_trial_20.png", path = here("figures"), plot = time_series_full_trial$plot[[2]], device = "png", width = 15, height = 10, units = "in",
#   dpi = 300)


###-------------------------------------------------------PLOT ANTICIPATION PERIOD------------------------------------------

## This plot loses some specificity to the time binning, compare to next section's plots which aren't based on time binned data. Should probably go with those other ones? 

time_series_antic <- data_time_series_antic %>%
  pivot_wider(names_from = AOI, values_from = Prop) %>%
  group_by(trial_type, language, age_group, trial_num) %>%
  summarise(target = mean(target, na.rm=TRUE),
            distractor = mean(distractor, na.rm=TRUE)) %>%
  pivot_longer(cols = c(target, distractor), names_to = "aoi", values_to = "prop_looking") %>%
  mutate(aoi = factor(aoi, levels = c("target", "distractor"))) %>%
  mutate(trial_labels = paste0("Trial ", trial_num)) %>%
  group_by(age_group) %>%
  nest() %>%
  mutate(plot_all = map2(data, age_group, ~ ggplot(data = .x, aes(x = trial_num, y = prop_looking, color = aoi, linetype = language)) + 
  geom_smooth(se = FALSE) +
  facet_grid( ~ trial_type) +
  ggtitle(age_group) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9)) +  
  xlab("Trial Number")  +
  ylab("Proportion looking")))
  
plot_anticipation_7 <- time_series_antic$plot_all[[1]]
plot_anticipation_20 <- time_series_antic$plot_all[[2]]

#ggsave("antic_7_plot.png", plot = antic_7_plot, width = 15, height = 7, path = here("figures"))
#ggsave("antic_20_plot.png", plot = antic_20_plot, width = 15, height = 7, path = here("figures"))


###----------------------------------------------PLOT ANTICIPATION PERIOD BY VOCAB GROUP--------------------------------

time_series_vocab <- data_time_series_antic %>%
  filter(age_group == "20 months") %>%
  pivot_wider(names_from = AOI, values_from = Prop) %>%
  group_by(trial_type, language, vocab_group, trial_num) %>%
  summarise(target = mean(target, na.rm=TRUE),
            distractor = mean(distractor, na.rm=TRUE))  %>%
  pivot_longer(cols = c(target, distractor), names_to = "aoi", values_to = "prop_looking") %>%
  mutate(aoi = factor(aoi, levels = c("target", "distractor")))  %>%
  mutate(trial_labels = paste0("Trial ", trial_num)) %>%
  ggplot(aes(x = trial_num, y = prop_looking, color = aoi, linetype = vocab_group)) + 
  geom_smooth(se = FALSE) +
  facet_grid(language ~ trial_type) +
  ggtitle("Proportion looking by vocab group (high/low) and language group") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9)) +  
  xlab("Trial Number") +
  ylab("Proportion looking")

plot_full_trial_7
plot_full_trial_20
plot_anticipation_7
plot_anticipation_20
time_series_vocab

```
##Model Data/Alternate Plots


```{r model_with_time_bins, echo = FALSE}
library(RColorBrewer)


tnum_7 <- data_time_series_antic %>%
  filter(age_group == "7 months",
         AOI == "target") %>%
  mutate(trial_num = factor(trial_num)) %>%
  group_by(TimeBin, trial_num, language, trial_type) %>%
  summarize(prop_looking = mean(Prop, na.rm = TRUE)) %>%
  ggplot(aes(x = TimeBin, y = prop_looking, color = trial_num)) +
  scale_color_brewer(palette = "Blues") +
  theme_dark() +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  coord_cartesian(ylim = c(0,1)) +
  facet_grid(language ~ trial_type) +
  ggtitle("7 months")

tnum_20 <- data_time_series_antic %>%
  filter(age_group == "20 months",
         AOI == "target") %>%
  mutate(trial_num = factor(trial_num)) %>%
  group_by(TimeBin, trial_num, language, trial_type) %>%
  summarize(prop_looking = mean(Prop, na.rm = TRUE)) %>%
  ggplot(aes(x = TimeBin, y = prop_looking, color = trial_num)) +
  scale_color_brewer(palette = "Blues") +
  theme_dark() +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  coord_cartesian(ylim = c(0,1)) +
  facet_grid(language ~ trial_type) +
  ggtitle("20 months")
  
ggsave("trial_models_20.png", plot = tnum_20)

d_7_pre <- data_time_series_antic %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(AOI == "target") 

d_7_post <-  data_time_series_antic %>%
  filter(age_group == "7 months",
         trial_type == "post-switch",
         AOI == "target") 

d_20_pre <- data_time_series_antic %>%
  filter(age_group == "20 months",
         trial_type == "pre-switch",
         AOI == "target") 

d_20_post <- data_time_series_antic %>%
  filter(age_group == "20 months",
         trial_type == "post-switch",
         AOI == "target")

newmodel_7pre <- glmer(cbind(SamplesInAOI, SamplesTotal-SamplesInAOI) ~ language * TimeBin * trial_num + (1 | recording_name), data = d_7_pre, family = "binomial", control = glmerControl(optimizer="bobyqa"))

newmodel_7post <- glmer(cbind(SamplesInAOI, SamplesTotal-SamplesInAOI) ~ language * TimeBin * trial_num + (1 | recording_name), data = d_7_post, family = "binomial", control = glmerControl(optimizer="bobyqa"))

newmodel_20pre <- glmer(cbind(SamplesInAOI, SamplesTotal-SamplesInAOI) ~ language * TimeBin + (1 | recording_name), data = d_20_pre, family = "binomial", control = glmerControl(optimizer="bobyqa"))

lmermodel_7pre <- lmer(Prop ~ language * TimeBin * trial_num + (1 | recording_name), data = d_7_pre)

lmermodel_7post <- lmer(Prop ~ language * TimeBin * trial_num + (1 | recording_name), data = d_7_post)

lmermodel_20pre <- lmer(Prop ~ language * TimeBin * trial_num + (1 | recording_name), data = d_20_pre)

lmermodel_20post <- lmer(Prop ~ language * TimeBin * trial_num + (1 | recording_name), data = d_20_post)

newmodel_20post <- glmer(cbind(SamplesInAOI, SamplesTotal-SamplesInAOI) ~ language * TimeBin * trial_num + (1 | recording_name), data = d_20_post, family = "binomial", control = glmerControl(optimizer="bobyqa"))



```


```{r eyetrackingR_models, echo = FALSE}


###----------------------------------------------------CREATE EYETRACKINGR DATA FOR MODELS--------------------------------------


##---------------------------------------------This gives us one data point per participant per trial - collapsing whole anticipation period
data_for_models <- data_eyetracking_clean %>%
  make_time_window_data(aois = "target",
                        predictor_columns = c("age_group", "language", "total_vocab_prod", "vocab_group", "trial_type", "trial_num")) %>%
  mutate(looking_ms = Prop * (SamplesTotal * (1000/60))) #adds number of milliseconds spent looking at target for the trial
  
##---------------------------------------------Plot vocab differences
  
vocab_plot <- data_for_models %>%
  filter(age_group == "20 months") %>%
  ggplot(aes(x = trial_num, y = Prop)) + 
  geom_smooth(aes(color = vocab_group), se = FALSE) +
  geom_point(position = "jitter", alpha = 0.2, aes(color = vocab_group)) +
  facet_grid(language ~ (trial_type)) +
  ggtitle("20 month-olds, Prop Looking by Vocab Group (H/L) & Language") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9)) +  
  geom_rect(data = data_for_models[1,], aes(fill = language),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf,alpha = 0.05) +
  geom_rect(data = data_for_models[9,], aes(fill = language),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf,alpha = 0.05) +
  geom_rect(data = data_for_models[15,], aes(fill = language),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf,alpha = 0.05) +
  geom_rect(data = data_for_models[23,], aes(fill = language),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf,alpha = 0.05) +
  xlab("Trial Number")  +
  ylab("Proportion looking")


anticipation_plots <- data_for_models %>%
  group_by(age_group) %>%
  nest() %>%
  mutate(plot = map2(data, age_group, ~ ggplot(data = .x, aes(x = trial_num, y = Prop)) + 
  geom_smooth(aes(color = language), se = FALSE) +
  geom_point(position = "jitter", alpha = 0.2, aes(color = language)) +
  facet_grid( ~ (trial_type)) +
  ggtitle(age_group) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9)) +  
  xlab("Trial Number")  +
  ylab("Logit looking"))) 
  
#(check$plot_check[[2]] / check$plot_check[[1]] | time_series_antic$plot_all[[1]] / time_series_antic$plot_all[[2]]) ## why are these slightly different? It's because of the time binning, I believe.

vocab_plot
(anticipation_plots$plot[[2]]/anticipation_plots$plot[[1]])

what <- ggplot(data_for_models, aes(x = trial_num, y = Prop, color = trial_type)) +
  geom_smooth(se = FALSE) +
  facet_wrap(age_group ~ recording_name)

#ggsave("with_circle_20.png", plot = check$plot_check[[1]], width = 15, height = 7, path = here("figures"))

```
##Models

For models, we want one data point per baby per trial to use (use made_time_window_data function)

each row from raw data is 1/60th of a second (60 Hz), approx. (added this to data but not sure what to do with it)

Play around and plot vocab score as well - get rid of distractor, and have mono-high, mono-low (median split for visualization) * check that medians are similar amongst groups (made these plots, can't run model on continuous vocab score without rescaling)
 
???? should there be a random slope for each participant by trial number?
 
```{r models, echo = FALSE}

###------------------------------------------------MODELS BY AGE, LANG, TRIAL TYPE---------------------------------------------  

models_by_language_trial_type <- data_for_models %>%
  mutate(trial_num_start_0 = trial_num - 1) %>%
  mutate(trial_num_5_centre = trial_num - 5) %>%
  mutate(trial_num_factor = factor(trial_num)) %>%
  mutate(trial_num_decimal_centre = scale(trial_num, center = TRUE, scale = FALSE)) %>%
  filter(trial_num > 1) %>%
  group_by(age_group, trial_type) %>%
  nest() %>%
  mutate(model1 = map(data, ~ glmer(cbind(SamplesInAOI, SamplesTotal-SamplesInAOI) ~ language * trial_num_start_0 + (1 | recording_name), data = ., family = "binomial", control = glmerControl(optimizer="bobyqa")))) 
  

model1_7_pre <- models_by_language_trial_type$model1[[3]]
summary(model1_7_pre)
model1_7_post <- models_by_language_trial_type$model1[[4]]
summary(model1_7_post)
model1_20_pre <- models_by_language_trial_type$model1[[1]]
summary(model1_20_pre)
model1_20_post <- models_by_language_trial_type$model1[[2]]
summary(model1_20_post)


emmeans(model1_20_pre, ~ trial_num * language)

library(effects)
library(ggeffects)
library(interactions)


ggpredict(model1_7_pre, c("trial_num_start_0", "language")) %>% plot()
ggpredict(model1_7_post, c("trial_num_start_0", "language")) %>% plot()
ggpredict(model1_20_pre, c("trial_num_start_0", "language")) %>% plot()
ggpredict(model1_20_post, c("trial_num_start_0", "language")) %>% plot()

interactions::interact_plot(model1_7_pre, pred = trial_num, modx = language)
interactions::interact_plot(model1_7_post, pred = trial_num, modx = language)
interactions::interact_plot(model1_20_pre, pred = trial_num, modx = language)
interactions::interact_plot(model1_20_post, pred = trial_num, modx = language)


##Quick GLM plots

p7pr <- data_for_models %>%
  filter(trial_type == "pre-switch",
         age_group == "7 months") %>%
ggplot(aes(x=trial_num, y=Prop, color = language)) +
  geom_point(aes(alpha = 0.1)) +
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = FALSE)

p7po <- data_for_models %>%
  filter(trial_type == "post-switch",
         age_group == "7 months") %>%
ggplot(aes(x=trial_num, y=Prop, color = language)) +
  geom_point(aes(alpha = 0.1)) +
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = FALSE)

p20pr <- data_for_models %>%
  filter(trial_type == "pre-switch",
         age_group == "20 months") %>%
ggplot(aes(x=trial_num, y=Prop, color = language)) +
  geom_point(aes(alpha = 0.1)) +
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = FALSE)

p20po <- data_for_models %>%
  filter(trial_type == "post-switch",
         age_group == "20 months") %>%
ggplot(aes(x=trial_num, y=Prop, color = language)) +
  geom_point(aes(alpha = 0.1)) +
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = FALSE)
(p7pr + p7po)/(p20pr + p20po)
```


```{r models_vocab}

data_20_pre <- data_for_models %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "pre-switch")

data_20_post <- data_for_models %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "post-switch")

data_for_models %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "pre-switch") %>%
  group_by(language, trial_num) %>%
  summarize(mean_prop = mean(Prop, na.rm = TRUE)) %>%
  ggplot(aes(x = trial_num, y = mean_prop)) + 
  geom_line(aes(color = language)) +
  geom_point(alpha = 0.2, aes(color = language)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9)) +  
  xlab("Trial Number")  +
  ylab("Prop looking")





###-----------------------------------------------MODELS BY LANG, TRIAL TYPE, VOCAB GROUP------------------------------------ 
############ fails to converge!!!

models_by_language_trial_type_vocab <- data_for_models %>%
  filter(age_group == "20 months") %>%
  group_by(trial_type) %>%
  nest() %>%
  mutate(model1 = map(data, ~ glmer(cbind(SamplesInAOI, SamplesTotal-SamplesInAOI) ~ language * trial_num * vocab_group + (1 | recording_name), data = ., family = "binomial", control = glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))) %>%
  mutate(model1_summary = map(model1, summary))

models_by_language_trial_type_vocab$model1_summary

```

##Growth Curve Analysis

```{r growth_curve, echo = FALSE}

###--------------------------------------------------------------GROWTH CURVE ANALYSIS------------------------------------ 

data_gc <- data_time_series_antic %>%
  filter(AOI == "target")

growth_curve1 <- data_gc %>%
  group_by(age_group, trial_type) %>%
  nest() %>%
  mutate(gc1 = map(data, ~ lmer(Elog ~ (ot1 + ot2 + ot3) * language * trial_num + (1 | recording_name), data = ., weights = Weights, control = lmerControl(optimizer="bobyqa"), REML = FALSE)))

gc1_7_pre <- growth_curve1$gc1[[3]]
gc1_7_post <- growth_curve1$gc1[[4]]
gc1_20_pre <- growth_curve1$gc1[[1]]
gc1_20_post <- growth_curve1$gc1[[2]]

summary(gc1_7_pre)
summary(gc1_7_post)
summary(gc1_20_pre)
summary(gc1_20_post)

data_for_gc_plot <- data_time_series_antic %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(AOI == "target")

##Plot below doesn't work because there are fewer fitted values than actual data points--why??

ggplot(data_for_gc_plot, aes(x = trial_num, y = Elog, color = language)) +
  stat_summary(fun.data = mean_se, geom = "pointrange") +
  stat_summary(aes(y = fitted(gc1_7_pre)), fun.y = mean, geom = "line")


length(fitted(gc1_7_pre))
length(data_for_gc_plot)

data_time_series_antic %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(AOI == "target") %>%
  View()

```

##Messy homeless code

```{r old_messy_code, include = FALSE}


###-------------------------------------------------MODELS BY AGE, LANG-------------------------------------------------------  
##this one makes no sense... obviously something is wrong. Can't add random slope per lang group by trial_type, though, b/c singular fit. Guess we'll have to keep models for pre and post switch separate??

models_by_language <- data_for_models %>%
  group_by(age_group) %>%
  nest() %>%
  mutate(model1 = map(data, ~ glmer(Prop ~ language * trial_num * trial_type + (1 | recording_name), data = ., family = "binomial", weights = Weights, control = glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))) %>%
  mutate(model1_summary = map(model1,  summary))

model1_7 <- models_by_language$model1[[2]]
summary(model1_7)
model1_20 <- models_by_language$model1[[1]]
summary(model1_20)


# models_by_language <- data_for_models %>% # trying with trial_type added as a random slope but fit is singular
#   group_by(age_group) %>%
#   nest() %>%
#   mutate(model = map(data, ~ glmer(cbind(SamplesInAOI, SamplesTotal - SamplesInAOI) ~ language * trial_num + (trial_type | recording_name) + (language | trial_type), data = ., family = "binomial", control = glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))) %>%
#   mutate(model_summary = map(model, summary))
# model2_7_pre <- models_by_language$model_summary[[2]]

## Same model as above but using Elog and lmer (shouldn't really use Prop for this data)

# models_by_language_trial_type <- models_by_language_trial_type %>%
#   mutate(model2 = map(data, ~ lmer(Elog ~ language * trial_num + (1 | recording_name), data = ., weights = Weights, control = lmerControl(optimizer="bobyqa")))) %>%
#   mutate(model2_summary = map(model2, summary))
# 
# model2_7_pre <- models_by_language_trial_type$model2[[3]]
# summary(model2_7_pre)
# model2_7_post <- models_by_language_trial_type$model2[[4]]
# summary(model2_7_post)
# model2_20_pre <- models_by_language_trial_type$model2[[1]]
# summary(model2_20_pre)
# model2_20_post <- models_by_language_trial_type$model2[[2]]
# summary(model2_20_post)


check_model1_7_pre <- data_for_models %>%
  mutate(trial_num = trial_num - 1) %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  glmer(cbind(SamplesInAOI, SamplesTotal-SamplesInAOI) ~ language * trial_num + (1 | recording_name), data = ., family = "binomial", control = glmerControl(optimizer="bobyqa"))



# model_pre_7_data <- data_for_models %>%
#   filter(trial_type == "pre-switch") %>%
#   filter(age_group == "7 months") %>%
#   filter(AOI == "target")
# 
# model_pre_7_3 <- glmer(Prop ~ language * trial_num + (1 | recording_name), data = model_pre_7_data_3, family = "binomial") #failed to converge when random slope by time_scaled added
# 
# summary(model_pre_7_3)
# 
# model_post_7_data_3 <- model_data_3 %>%
#   filter(trial_type == "post-switch") %>%
#   filter(age_group == "7 months") %>%
#   filter(AOI == "target")
# 
# 
# model_post_7_3 <- glmer(Prop ~ language * trial_num + (1 | recording_name), data = model_post_7_data_3, family = "binomial") #failed to converge when random slope by time_scaled added
# 
# summary(model_post_7_3)

model_data_3 %>% 
  group_by(trial_num, trial_type, language, age_group) %>%
  summarize(means = mean(Prop, na.rm = TRUE))

## this data keeps binned timestamps -- question: the "AOI" column now has target and distractor stacked on top of one another. Not sure if we should be excluding distractor?
model_data <- data_time_series_antic %>%
  mutate(language_c = ifelse(language == "Monolinguals", -.5, .5)) %>% # sum-code and centre predictors 
  mutate(language_c = as.numeric(scale(language_c, center = TRUE, scale = FALSE))) %>% #  sum-code and centre predictors 
  mutate(trial_type_c = ifelse(trial_type == "pre-switch", -.5, .5)) %>%
  mutate(trial_type_c = as.numeric(scale(trial_type_c, center = TRUE, scale = FALSE))) %>%
  mutate(time_scaled = Time / 1000) #rescale time to help with large eigenvalue thing as done here: https://bit.ly/2O3tQne 



# this data keeps continuous timestamps and uses the count of TRUES in the "target" column for the DV:
model_data_2 <- data_eyetracking_clean %>%
  mutate(language_c = ifelse(language == "Monolinguals", -.5, .5)) %>% # sum-code and centre predictors 
  mutate(language_c = as.numeric(scale(language_c, center = TRUE, scale = FALSE))) %>% #  sum-code and centre predictors 
  mutate(trial_type_c = ifelse(trial_type == "pre-switch", -.5, .5)) %>%
  mutate(trial_type_c = as.numeric(scale(trial_type_c, center = TRUE, scale = FALSE))) %>%
  mutate(time_scaled = trial_from_zero / 1000)
  
###----------------------------------------------------------------------PRE-SWITCH 7-------------------------------------------------------------  
  
model_pre_7_data <- model_data %>%
  filter(trial_type == "pre-switch") %>%
  filter(age_group == "7 months") %>%
  filter(AOI == "target")


model_pre_7 <- glmer(Prop ~ language * trial_num + (1 | recording_name), data = model_pre_7_data, family = "binomial") #failed to converge when random slope by time_scaled added

summary(model_pre_7)

plot(model_pre_7) # question: is this problematic?


model_pre_7_data_2 <- model_data_2 %>%
  filter(trial_type == "pre-switch") %>%
  filter(age_group == "7 months")


model_pre_7_2 <- glmer(target ~ language * time_scaled + (1 | recording_name), data = model_pre_7_data_2, family = "binomial")

summary(model_pre_7_2)
plot(model_pre_7_2) # I have no idea how to interpret these


###----------------------------------------------------------------------POST-SWITCH 7-------------------------------------------------------------  

model_post_7_data <- model_data %>%
  filter(trial_type == "post-switch") %>%
  filter(age_group == "7 months") %>%
  filter(AOI == "target")


model_post_7 <- glmer(Prop ~ language * time_scaled + (1 | recording_name), data = model_post_7_data, family = "binomial")

summary(model_post_7)


model_post_7_data$prediction <- predict(model_post_7, model_post_7_data)

# in logit space...
ggplot(model_post_7_data, aes(x=time_scaled, y=prediction, color=language)) +
                            stat_summary(fun.y='mean', geom='line')


###----------------------------------------------------------------------PRE-SWITCH 20-------------------------------------------------------------  
  
model_pre_20_data <- model_data %>%
  filter(trial_type == "pre-switch") %>%
  filter(age_group == "20 months")%>%
  filter(AOI == "target") %>%
  filter(trial_num != 1)


model_pre_20 <- glmer(Prop ~ language * (ot1 + ot2 + ot3) + (1 | recording_name), data = model_pre_20_data, family = "binomial")

summary(model_pre_20)

model_pre_20_2 <- lmer(Elog ~ language * (ot1 + ot2 + ot3) + (1 | recording_name) + (1 | trial_num), data = model_pre_20_data, REML = FALSE)

summary(model_pre_20_2)


###----------------------------------------------------------------------POST-SWITCH 20-------------------------------------------------------------  

model_post_20_data <- model_data %>%
  filter(trial_type == "post-switch") %>%
  filter(age_group == "20 months")

model_post_20 <- glmer(Prop ~ language * time_scaled + (1 | recording_name), data = model_post_20_data, family = "binomial")

summary(model_post_20)


```

##Anovas

```{r anovas, echo = FALSE}

agg_subjects <- data_eyetracking_clean %>%
  group_by(recording_name, age_group, language, trial_type) %>%
  summarize(prop_target = mean(target, na.rm = TRUE)) %>% #this includes all looks though, not just target vs distractor
  ungroup()

ggplot(agg_subjects, aes(x = language, y = prop_target, color = language))  +
  geom_point(position = position_jitter(.3)) +
  facet_grid(age_group ~ fct_rev(trial_type))
```


