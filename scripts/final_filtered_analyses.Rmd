---
title: "Final Filtered Analyses"
author: "Hilary Killam"
date: "13/08/2020"
output: html_document
---

#Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

## Load packages
library(tidyverse)
library(readxl)
library(stringr)
library(tidyr)
library(ggplot2)
library(car)
library(ez)
library(snakecase)
library(janitor)
library(lme4)
library(effects)
library(emmeans)
library(apaTables)
library(here)
library(eyetrackingR)
library(patchwork)
library(ggeffects)
library(interactions)
library(gt)
library(flextable)
library(grDevices)
library(apa)
library(sjPlot)
options(scipen = 999)

kovacs09 <- "KovÃ¡cs & Mehler 2009"

## Define minimum looking and minimum trial numbers for this study
MIN_LOOK_PROPORTION <- .5
MIN_NUMBER_TRIALS <- 5
TL_PROP <- 0.5

blues_palette <- colorRampPalette(c("#C6DBEF", "#081D58"))
blues <- blues_palette(9)

```

#Load Data

```{r load_data, include = FALSE}

###------------------------------------------------------LOAD DATA-------------------------------------------------

#Full Trials (with final sample only - excluded babies already removed in load and merge script)
load(here("data", "data_full_trials.Rda"))

#Master Subject List (with final sample only - excluded babies already removed in load and merge script)
load(here("data", "final_sample_mslist.Rda"))

#fix one date of birth that is wrong in MSL
final_sample_mslist <- final_sample_mslist %>%
  mutate(do_birth = case_when(baby_id == 45798 ~ lubridate::ymd(20160924),
                              TRUE ~ lubridate::ymd(do_birth)),
         months = case_when(baby_id == 45798 ~ 20,
                            TRUE ~ months),
         days = case_when(baby_id == 45798 ~ 9,
                          TRUE ~ days),
         total_age_days_excel = case_when(baby_id == 45798 ~ 616,
                                          TRUE ~ total_age_days_excel))

#Exclusion data (includes everyone -- excluded and included)
load(here("data", "exclusions.Rda"))

```

#FINAL, FILTERED DATASET

##Descriptives

```{r descriptives, echo = FALSE}

###------------------------------------------------FINAL SAMPLE COUNTS PER AGE--------------------------------------

final_sample_mslist %>% 
  mutate(do_birth = lubridate::ymd(do_birth),
         do_participation = lubridate::ymd(do_participation),
         age_interval = lubridate::interval(do_birth, do_participation),
         age_total = lubridate::as.period(age_interval),
         years = lubridate::year(age_total),
         months = lubridate::month(age_total),
         days = lubridate::day(age_total),
         months = years*12 + months) %>%
  select(-age_interval, -age_total, -years) %>%
  group_by(age_group) %>%
  summarize(count = length(unique(recording_name)),
            avg_age_days = floor(mean(total_age_days_excel, na.rm = TRUE)),
            min_age_days = min(total_age_days_excel),
            max_age_days = max(total_age_days_excel),
            avg_age = avg_age_days/30.436875, #divide by average days in a month
            avg_months = floor(avg_age),
            avg_days = floor((avg_age - avg_months) * 30.436875),
            min_age = min_age_days/30.436875,
            min_months = floor(min_age),
            min_days = floor((min_age - min_months) * 30.436875),
            max_age = max_age_days/30.436875,
            max_months = floor(max_age),
            max_days = floor((max_age - max_months) * 30.436875),            
            num_female = sum(gender == 1)) %>%
  select(-avg_age_days, -min_age_days, -max_age_days, -avg_age, -min_age, -max_age)
  

###------------------------------------------------FINAL SAMPLE COUNTS PER GROUP--------------------------------------

final_sample_mslist %>% 
  group_by(language, age_group) %>%
  summarize(count = length(unique(recording_name)),
            vocab_median = median(cdi_tot_vocab_prod, na.rm = TRUE), 
            vocab_mean = mean(cdi_tot_vocab_prod, na.rm = TRUE),
            avg_age_days = floor(mean(total_age_days_excel, na.rm = TRUE)),
            min_age_days = min(total_age_days_excel),
            max_age_days = max(total_age_days_excel),
            avg_age = avg_age_days/30.436875, #divide by average days in a month
            avg_months = floor(avg_age),
            avg_days = floor((avg_age - avg_months) * 30.436875),
            min_age = min_age_days/30.436875,
            min_months = floor(min_age),
            min_days = floor((min_age - min_months) * 30.436875),
            max_age = max_age_days/30.436875,
            max_months = floor(max_age),
            max_days = floor((max_age - max_months) * 30.436875),            
            num_female = sum(gender == 1)) %>%
  select(-avg_age_days, -min_age_days, -max_age_days, -avg_age, -min_age, -max_age)



###-----------------------------------------------FINAL SAMPLE COUNTS PER LANG BACKGROUND------------------------------

final_sample_mslist %>% 
  group_by(age_group, language, group) %>%
  summarize(count = length(unique(recording_name)))


###-----------------------------------------------FINAL SAMPLE COUNTS PER EXCLUSION REASON--------------------------

exclusions %>%
  count(age_group, excl_reason) %>%
  arrange(age_group, desc(n))

###----------------------------------------------------------COMPARE GROUPS------------------------------
summary_7 <- final_sample_mslist %>%
  filter(age_group == "7 months") 

summary_20 <- final_sample_mslist %>%
  filter(age_group == "20 months")

summary(summary_7$total_age_days_excel)
summary(summary_20$total_age_days_excel)

ggplot(summary_7, aes(total_age_days_excel)) + 
  geom_histogram(binwidth = 10) + 
  facet_wrap(~ language)

ggplot(summary_20, aes(total_age_days_excel)) + 
  geom_histogram(binwidth = 10) + 
  facet_wrap(~ language)

t.test(total_age_days_excel ~ language, data = summary_7) # no age diff between mono and bi 7 month olds
t.test(total_age_days_excel ~ language, data = summary_20) # no age diff between mono and bi 20 month olds

###----------------------------------------------------------COMPARE MATERNAL EDUCATION------------------------------

final_sample_mslist %>% #for regular models (no vocab) - to get details for vocab model, change to final_sample_mslist_vocab
  mutate(mother_edu = case_when(is.na(mother_edu) ~ "other",
                                TRUE ~ mother_edu)) %>%
  group_by(age_group, language) %>%
  count(mother_edu) %>%
  mutate(pct = n/sum(n)) %>%
  arrange(age_group, language, desc(n))


exclusions %>% 
  count(age_group, excl_reason)

```


##EyetrackingR Data

```{r eyetrackingR_data, echo = FALSE}

###----------------------------------------------------CREATE EYETRACKINGR DATA FOR FULL TRIAL PLOTS

data_eyetracking_full_trials <- make_eyetrackingr_data(data_full_trials, 
                                participant_column = "recording_name",
                                trial_column = "trial_name", 
                                time_column = "trial_from_zero",
                                trackloss_column = "trackloss",
                                aoi_columns = c('target', 'circle', 'distractor'), # this will calculate prop looking in relation to all AOIs, not just target vs distractor. When I remove circle from here, the plot gets very wonky (I guess because of dividing by 0 in some cases?)
                                treat_non_aoi_looks_as_missing = TRUE)

full_trial_window <- subset_by_window(data_eyetracking_full_trials,
                                     window_start_time = 0,
                                     window_end_time = 5000, rezero = TRUE, remove = TRUE)

data_time_series_full <- make_time_sequence_data(full_trial_window,
                                         time_bin_size = 200,
                                         predictor_columns = c("language", "age_group", "cdi_tot_vocab_prod", "vocab_group", "vocab_centred", "vocab_scaled", "trial_type", "trial_num"),
                                         aois = c("circle", "target", "distractor"))

###---------------------------------------------CREATE EYETRACKINGR DATA FOR ANTICIPATION PERIOD PLOTS

data_eyetracking_antic_window <- subset_by_window(data_eyetracking_full_trials,
                                     window_start_time = 2150,
                                     window_end_time = 3150, rezero = TRUE, remove = TRUE)

trackloss <- trackloss_analysis(data = data_eyetracking_antic_window)

data_eyetracking_clean <- clean_by_trackloss(data = data_eyetracking_antic_window, trial_prop_thresh = TL_PROP) #this eliminates all data from trials with 50% or more trackloss (we merged the baby IDs who made it through to the final sample back with the full data, so makes sense we will re-exclude some trials here)

data_time_series_antic <- make_time_sequence_data(data_eyetracking_clean,
                                         time_bin_size = 200,
                                         predictor_columns = c("language", "age_group", "cdi_tot_vocab_prod", "vocab_group", "vocab_centred", "vocab_scaled", "trial_type", "trial_num"),
                                         aois = c("circle", "target", "distractor"))

```


##Time Series Plots

```{r color-blind palette}
cb_palette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#0072B2", "#D55E00", "#CC79A7", "#F0E442")

image(1:length(cb_palette), 1, as.matrix(1:length(cb_palette)), 
      col= cb_palette,
      xlab="", ylab = "", xaxt = "n", yaxt = "n", bty = "n")
```


```{r time_series_plots, echo = FALSE}

###----------------------------------------------------------PLOT FULL TRIALS-----------------------------------------
#line_colors <- c("#D7D7D7", "#FF3366", "#04BDD8")
#line_colors <- c("#D7D7D7", "#f77a6f", "#0485d6")
line_colors <- c("#D55E00", "#0072B2") #c("#f77a6f", "#016abf")
line_types <- c("dotted", "solid", "dashed")
line_sizes <- c(.6, 0.5, 0.5)
facet_text <- data.frame(trial_labels = c("Trial 1"), language = c("Monolinguals"), aoi = c("target"), Time = c(2650), trial_type_labs= c("Training", "Test"), prop_looking = c(.875), label = c("Anticipation period"))


time_series_full_trial <- data_time_series_full %>%
  filter(Time >= 1400 & Time <= 4000) %>%
  mutate(trial_type_labs = case_when(trial_type == "pre-switch" ~ "Training",
                                     trial_type == "post-switch" ~ "Test")) %>%
  mutate(trial_type_labs = factor(trial_type_labs, levels = c("Training", "Test"))) %>%
  pivot_wider(names_from = AOI, values_from = Prop) %>%
  group_by(trial_type_labs, language, age_group, Time, trial_num) %>%
  summarise(target = mean(target, na.rm=TRUE), 
            distractor = mean(distractor, na.rm=TRUE),
            circle = mean(circle, na.rm = TRUE))  %>%
  pivot_longer(cols = c(circle, target, distractor), names_to = "aoi", values_to = "prop_looking") %>%
  mutate(aoi = factor(aoi, levels = c("circle", "target", "distractor")),
         trial_labels = paste0("Trial ", trial_num),
         xmin = case_when(Time == 2000 & language == "Monolinguals" & aoi == "target" ~ 2150, #setting up the layer for the transparent rectangle showing the anticipation period
         TRUE ~ 2000),
         xmax = case_when(Time == 2000 & language == "Monolinguals" & aoi == "target" ~ 3150,
         TRUE ~ 2000),
         ymin = case_when(Time == 2000 & language == "Monolinguals" & aoi == "target" ~ Inf,
         TRUE ~ 0),
         ymax = case_when(Time == 2000 & language == "Monolinguals" & aoi == "target" ~ -Inf,
         TRUE ~ 0),
         experiment = case_when(age_group == "7 months" ~ "1a", # edit here
                                age_group == "20 months" ~ "2")) %>% 
  group_by(age_group) %>%
  nest() %>%
  #create nested data for easily plotting more than one of the same plot by a group
  mutate(plot = map2(data, age_group, ~ ggplot(data = .x, aes(x = Time, y = prop_looking, color = language, linetype = aoi)) + 
  geom_rect(aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = "Anticipation Period"), alpha = .1, colour = "transparent", show.legend = FALSE) +
  geom_line(aes(alpha = aoi, size = aoi)) +
  scale_color_manual(values = line_colors, guide = guide_legend(order = 1)) +
  scale_fill_manual(values = "#ffb600", labels = c("Anticipation Period"), guide = guide_legend(order = 3)) +
  scale_linetype_manual(values = line_types, labels = c("Central fixation area", "Correct side", "Incorrect side"), guide = guide_legend(order = 2)) +
  scale_y_continuous(n.breaks = 3) +
  scale_x_continuous(breaks = c(2000, 3000, 4000)) +
  scale_alpha_manual(values = c(0.5, 0.9, 0.725), guide = "none") +
  scale_size_manual(values = line_sizes, guide = "none") +
  labs(linetype = "Area of interest",
       color = "Language group",
       fill = "Time period") +
  geom_text(data = facet_text, label = facet_text$label, show.legend = FALSE, color = "#666666", size = 3) +
  facet_grid(trial_labels ~ trial_type_labs) +
  # annotate("rect", xmin = 2150, xmax = 3150, ymin = -Inf, ymax = Inf, fill = "#fff000", alpha = 0.1) +
  # annotate("text", x = 2650, y = 0.875, label = "Anticipation \n Period", size = 2.75, color = "#927774") +
  ggtitle(paste0("Time course of infant looking for Study ", .$experiment, " (age ", age_group, ")")) + 
  theme_minimal(base_size = 13.5) +
  theme(plot.title = element_text(hjust = 0.5),
        strip.background = element_rect(fill = "#D9D9D9", color = "#9b9b9b"),
        panel.background = element_rect(fill = "transparent", color = "transparent"),
        panel.grid = element_line(color = "#eaeaea"),
        panel.grid.major = element_line(size = .25),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.spacing = unit(.5, "lines"),
        axis.text = element_text(size = 10)) +
  xlab("\nTime from trial start (ms)")  +
  ylab("Proportion looking\n"))) 

  
plot_full_7 <- time_series_full_trial$plot[[1]] 
plot_full_20 <- time_series_full_trial$plot[[2]] 

#--------------------------------Uncomment to resave figures:

 # ggsave("plot_full_trial_7_filtered_final.png", path = here("figures"), plot = time_series_full_trial$plot[[1]], device = "png", width = 9, height = 9, units = "in", dpi = 300)
 # ggsave("plot_full_trial_20_filtered_final.png", path = here("figures"), plot = time_series_full_trial$plot[[2]], device = "png", width = 9, height = 9, units = "in", dpi = 300)


###------------------------------------------PLOT ANTICIPATION PERIOD------------------------------------------

### These plots show accuracy over the course of trials, not time bins

time_series_antic <- data_time_series_antic %>%
  pivot_wider(names_from = AOI, values_from = Prop) %>%
  group_by(trial_type, language, age_group, trial_num) %>%
  summarise(target = mean(target, na.rm=TRUE),
            distractor = mean(distractor, na.rm=TRUE)) %>%
  pivot_longer(cols = c(target, distractor), names_to = "aoi", values_to = "prop_looking") %>%
  mutate(aoi = factor(aoi, levels = c("target", "distractor"))) %>%
  mutate(trial_labels = paste0("Trial ", trial_num)) %>%
  group_by(age_group) %>%
  nest() %>%
  mutate(plot_all = map2(data, age_group, ~ ggplot(data = .x, aes(x = trial_num, y = prop_looking, color = language, linetype = aoi)) + 
  geom_smooth(se = FALSE) +
  facet_grid( ~ trial_type) +
  ggtitle(age_group) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9)) +  
  xlab("Trial Number")  +
  ylab("Proportion looking")))
  
plot_anticipation_7 <- time_series_antic$plot_all[[1]]
plot_anticipation_20 <- time_series_antic$plot_all[[2]]

#ggsave("antic_7_plot.png", plot = antic_7_plot, width = 15, height = 7, path = here("figures"))
#ggsave("antic_20_plot.png", plot = antic_20_plot, width = 15, height = 7, path = here("figures"))


```

##Models
###Model data

```{r}

#---------------------------------Model data with time bin 2 as baseline (the middle)

model_data <- data_time_series_antic %>%
  filter(AOI == "target",
         trial_num != 1) %>%
  mutate(trial_num_scaled = trial_num - 2,
         time_bin_centred = TimeBin - 2)

model_data_7_pre <- model_data %>%
  filter(age_group == "7 months",
         trial_type == "pre-switch")

model_data_7_post <-  model_data %>%
  filter(age_group == "7 months",
         trial_type == "post-switch") 

model_data_20_pre <- model_data %>%
  filter(age_group == "20 months",
         trial_type == "pre-switch",
         AOI == "target")

model_data_20_post <- model_data %>%
  filter(age_group == "20 months",
         trial_type == "post-switch",
         AOI == "target")


```


### raw model data plots

For models, we want one data point per baby per trial to use (use made_time_window_data function)

```{r}
#plots with raw data points to compare to model prediction plots later

model_data_7_pre %>% ggplot(aes(x = TimeBin, y = Prop, color = as.factor(trial_num_scaled))) + 
  geom_jitter(alpha = 0.8, shape = 21, stroke = .75) + 
  geom_smooth(aes(color = as.factor(trial_num_scaled)), se = FALSE) + 
  facet_grid( ~ language) + 
  scale_color_manual(values = blues, labels = c(2, 3, 4, 5, 6, 7, 8, 9)) +
  labs(color = "trial_num", title = "Pre-Switch 7")
#ggsave("plot_model_data_7pre.png", path = here("figures"), device = "png", width = 7, height = 4, units = "in", dpi = 300)

model_data_7_post %>% ggplot(aes(x = TimeBin, y = Prop, color = as.factor(trial_num_scaled))) + 
  geom_jitter(alpha = 0.8, shape = 21, stroke = .75) + 
  geom_smooth(aes(color = as.factor(trial_num_scaled)), se = FALSE) + 
  facet_grid( ~ language) + 
  scale_color_manual(values = blues, labels = c(2, 3, 4, 5, 6, 7, 8, 9)) +
  labs(color = "trial_num", title = "Post-Switch 7")
#ggsave("plot_model_data_7post.png", path = here("figures"), device = "png", width = 7, height = 4, units = "in", dpi = 300)

model_data_20_pre %>% 
  ggplot(aes(x = TimeBin, y = Prop, color = as.factor(trial_num_scaled))) + 
  geom_jitter(alpha = 0.8, shape = 21, stroke = .75) + 
  geom_smooth(aes(color = as.factor(trial_num_scaled)), se = FALSE) + 
  facet_grid( ~ language) + 
  scale_color_manual(values = blues, labels = c(2, 3, 4, 5, 6, 7, 8, 9)) +
  labs(color = "trial_num", title = "Infant looking to correct side, Study 2 (Training)")

#ggsave("plot_model_data_20pre.png", path = here("figures"), device = "png", width = 7, height = 4, units = "in", dpi = 300)

model_data_20_post %>%
  ggplot(aes(x = TimeBin, y = Prop, color = as.factor(trial_num_scaled))) + 
  geom_jitter(alpha = 0.8, shape = 21, stroke = .75) + 
  geom_smooth(aes(color = as.factor(trial_num_scaled)), se = FALSE) + 
  facet_grid( ~ language) + 
  scale_color_manual(values = blues, labels = c(2, 3, 4, 5, 6, 7, 8, 9)) +
  labs(color = "trial_num", title = "Infant looking to correct side, Study 2 (Test)")

#ggsave("plot_model_data_20post.png", path = here("figures"), device = "png", width = 7, height = 4, units = "in", dpi = 300)

###-------------------------------Plot kid by kid, to see missing data

model_data_7_pre %>% 
  filter(language == "Monolinguals") %>%
  ggplot(aes(x = TimeBin, y = Prop)) + 
  geom_jitter() + 
  geom_line() + 
  ggtitle("Monolinguals, Pre-Switch") +
  facet_grid(recording_name ~ trial_num_scaled)

#ggsave("plot_mono_7allpre.png", path = here("figures"), device = "png", width = 7, height = 10, units = "in", dpi = 300)

model_data_7_pre %>% 
  filter(language == "Bilinguals") %>%
  ggplot(aes(x = TimeBin, y = Prop)) + 
  geom_jitter() + 
  geom_line() + 
  ggtitle("Bilinguals, Pre-Switch") +
  facet_grid(recording_name ~ trial_num_scaled)

#ggsave("plot_bi_7allpre.png", path = here("figures"), device = "png", width = 7, height = 10, units = "in", dpi = 300)

model_data_7_post %>% 
  filter(language == "Monolinguals") %>%
  ggplot(aes(x = TimeBin, y = Prop)) + 
  geom_jitter() + 
  geom_line() + 
  ggtitle("Monolinguals, Post-Switch") +
  facet_grid(recording_name ~ trial_num_scaled)

#ggsave("plot_mono_all7post.png", path = here("figures"), device = "png", width = 7, height = 10, units = "in", dpi = 300)

model_data_7_post %>% 
  filter(language == "Bilinguals") %>%
  ggplot(aes(x = TimeBin, y = Prop)) + 
  geom_jitter() + 
  geom_line() + 
  ggtitle("Bilinguals, Post-Switch") +
  facet_grid(recording_name ~ trial_num_scaled)

#ggsave("plot_bi_all7post.png", path = here("figures"), device = "png", width = 7, height = 10, units = "in", dpi = 300)


model_data_20_pre %>% 
  filter(language == "Monolinguals") %>%
  ggplot(aes(x = TimeBin, y = Prop)) + 
  geom_jitter() + 
  geom_line() + 
  ggtitle("Monolinguals, Pre-Switch") +
  facet_grid(recording_name ~ trial_num_scaled)

#ggsave("plot_vocab_mono_20pre.png", path = here("figures"), device = "png", width = 7, height = 10, units = "in", dpi = 300)


model_data_20_pre %>% 
  filter(language == "Bilinguals") %>%
  ggplot(aes(x = TimeBin, y = Prop)) + 
  geom_jitter() + 
  geom_line() + 
  ggtitle("Bilinguals, Post-Switch") +
  facet_grid(recording_name ~ trial_num_scaled)

#ggsave("plot_vocab_bi_20pre.png", path = here("figures"), device = "png", width = 7, height = 10, units = "in", dpi = 300)

model_data_20_post %>% 
  filter(language == "Monolinguals") %>%
  ggplot(aes(x = TimeBin, y = Prop)) + 
  geom_jitter() + 
  geom_line() + 
  ggtitle("Monolinguals, Post-Switch") +
  facet_grid(recording_name ~ trial_num_scaled)

#ggsave("plot_vocab_mono_20post.png", path = here("figures"), device = "png", width = 7, height = 10, units = "in", dpi = 300)

model_data_20_post %>% 
  filter(language == "Bilinguals") %>%
  ggplot(aes(x = TimeBin, y = Prop)) + 
  geom_jitter() + 
  geom_line() +
  ggtitle("Bilinguals, Post-Switch") +
  facet_grid(recording_name ~ trial_num_scaled)

#ggsave("plot_vocab_bi_20post.png", path = here("figures"), device = "png", width = 7, height = 10, units = "in", dpi = 300)

```


### models - 7 m
```{r}

###------------------------------------------------------------GLMER - MOST APPROPRIATE-----


###---------------------------------------------------PRESWITCH 7--------------

#-----------random intercept
glmermodel_7pre <- glmer(SamplesInAOI / SamplesTotal ~ language * time_bin_centred * trial_num_scaled + (1 | recording_name), data = model_data_7_pre, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))) # nearly everything is significant in the glmer model

#Null model
glmer_null_7pre <- glmer(SamplesInAOI / SamplesTotal ~ 1 + (1 | recording_name), data = model_data_7_pre, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

anova(glmer_null_7pre, glmermodel_7pre) # model with fixed effects is much better than intercept-only

final_model_pre_7 <- glmermodel_7pre
  
summary(final_model_pre_7)

###----------------------------------------------------POST SWITCH 7--------------


#random intercept
glmermodel_7post <- glmer(SamplesInAOI / SamplesTotal ~ language * time_bin_centred * trial_num_scaled + (1 | recording_name), data = model_data_7_post, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))) # nearly everything is significant in the glmer model

tab_model(glmermodel_7post, show.re.var = FALSE, show.icc = FALSE)

final_model_post_7 <- glmermodel_7post

summary(final_model_post_7)

###----------------------------------------------------TABLES OF MODEL RESULTS-----------------

tab_model(final_model_pre_7, show.re.var = FALSE, show.icc = FALSE)
tab_model(final_model_post_7, show.re.var = FALSE, show.icc = FALSE)

###----------------------------------------------------PLOTS OF MODEL RESULTS - GLMER-----------------

ggpredict(final_model_pre_7, terms = c("time_bin_centred", "trial_num_scaled", "language"), type = "re", ci.lvl = FALSE) %>% plot(colors = "trial_num_scaled", line.size = 1, connect.lines = TRUE) +
  labs(title = "Predicted values of proportion looking to target during the Training phase \nin Study 1a (filtered data)", x = "Time in milliseconds during anticipation period", y = "Proportion looking to target", color = "Trial number") +
  scale_color_manual(values = blues, labels = c(2, 3, 4, 5, 6, 7, 8, 9)) +
  scale_x_continuous(breaks = c(-2, 0, 2), labels = c("0", "500", "1000")) +
  ylim(-0.1, 1) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)))

#ggsave("plot_model_7_pre_filtered.png", path = here("figures"), device = "png", width = 7, height = 4, units = "in", dpi = 300)
 

ggpredict(final_model_post_7, terms = c("time_bin_centred", "trial_num_scaled", "language"), type = "fe", ci.lvl = FALSE) %>% plot(colors = "trial_num_scaled", line.size = 1, connect.lines = TRUE) +
  labs(title = "Predicted values of proportion looking to target during the Test phase \nin Study 1a (filtered data)", x = "Time in milliseconds during anticipation period", y = "Proportion looking to target", color = "Trial number") +
  scale_color_manual(values = blues, labels = c(2, 3, 4, 5, 6, 7, 8, 9)) +
  scale_x_continuous(breaks = c(-2, 0, 2), labels = c("0", "500", "1000")) +
  ylim(-0.1, 1) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)))

#ggsave("plot_model_7_post_filtered.png", path = here("figures"), device = "png", width = 7, height = 4, units = "in", dpi = 300)
 
```


###models - 20 m
```{r}

###-------------------------------------------------------------PRE SWITCH 20--------------


#This model is overfitting - let's remove the interaction between vocab and time bin
glmermodel_20pre <- glmer(SamplesInAOI / SamplesTotal ~ language * time_bin_centred * trial_num_scaled + (1 | recording_name), data = model_data_20_pre, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

###-------------------------------------------------------------------FINAL MODEL-------------

final_model_pre_20 <- glmermodel_20pre

###-------------------------------------------------------------POST SWITCH 20--------------

glmermodel_20post <- glmer(SamplesInAOI / SamplesTotal ~ language * time_bin_centred * trial_num_scaled + (1 | recording_name), data = model_data_20_post, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

###-------------------------------------------------------------------FINAL MODEL-------------

final_model_post_20 <- glmermodel_20post


###----------------------------------------------------TABLE OF MODEL RESULTS-----------------

tab_model(final_model_pre_20, show.re.var = FALSE, show.icc = FALSE)
tab_model(final_model_post_20, show.re.var = FALSE, show.icc = FALSE)

##----------------------------------------------------------PLOT OF MODEL RESULTS - GLMER------------

ggpredict(final_model_pre_20, terms = c("time_bin_centred", "trial_num_scaled", "language"), type = "re", ci.lvl = FALSE) %>% plot(colors = "trial_num_scaled", line.size = 1, connect.lines = TRUE) +
  labs(title = "Predicted values of proportion looking to target during the Training phase \nin Study 2 (filtered data)", x = "Time in milliseconds during anticipation period", y = "Proportion looking to target", color = "Trial number") +
  scale_color_manual(values = blues, labels = c(2, 3, 4, 5, 6, 7, 8, 9)) +
  scale_x_continuous(breaks = c(-2, 0, 2), labels = c("0", "500", "1000")) +
  ylim(-0.1, 1) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)))

#ggsave("plot_model_20_pre_filtered_final.png", path = here("figures"), device = "png", width = 7, height = 4, units = "in",  dpi = 300)

ggpredict(final_model_post_20, terms = c("time_bin_centred", "trial_num_scaled", "language"), type = "re", ci.lvl = FALSE) %>% plot(colors = "trial_num_scaled", line.size = 1, connect.lines = TRUE) +
  labs(title = "Predicted values of proportion looking to target during the Test phase \nin Study 2 (filtered data)", x = "Time in milliseconds during anticipation period", y = "Proportion looking to target", color = "Trial number") +
  scale_color_manual(values = blues, labels = c(2, 3, 4, 5, 6, 7, 8, 9)) +
  scale_x_continuous(breaks = c(-2, 0, 2), labels = c("0", "500", "1000")) +
  ylim(-0.1, 1) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)))

#ggsave("plot_model_20_post_filtered_final.png", path = here("figures"), device = "png", width = 7, height = 4, units = "in", dpi = 300)

```

###Models plus flipped models to compare baseline effects

```{r}
#monolinguals as baseline
tab_model(final_model_pre_7)
tab_model(final_model_post_7)
tab_model(final_model_pre_20)
tab_model(final_model_post_20)

#bilinguals as baseline (this lets us see the true direction of effects for bilinguals when it's tricky to calculate)
flipped_pre_7 <- glmer(SamplesInAOI / SamplesTotal ~ factor(language, levels = c("Bilinguals", "Monolinguals")) * time_bin_centred * trial_num_scaled + (1 | recording_name), data = model_data_7_pre, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

flipped_post_7 <-glmer(SamplesInAOI / SamplesTotal ~ factor(language, levels = c("Bilinguals", "Monolinguals")) * time_bin_centred * trial_num_scaled + (1 | recording_name), data = model_data_7_post, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

flipped_pre_20 <- glmer(SamplesInAOI / SamplesTotal ~ factor(language, levels = c("Bilinguals", "Monolinguals")) * time_bin_centred * trial_num_scaled + (1 | recording_name), data = model_data_20_pre, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

flipped_post_20 <- glmer(SamplesInAOI / SamplesTotal ~ factor(language, levels = c("Bilinguals", "Monolinguals")) * time_bin_centred * trial_num_scaled + (1 | recording_name), data = model_data_20_post, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))


tab_model(flipped_pre_7)
tab_model(flipped_post_7)
tab_model(flipped_pre_20)
tab_model(flipped_post_20)

```

###Models to check learning

```{r}
###---------------------------------------------------Compare Training trial 9 to Test trial 1 to verify infants learned


#------------------------------------7 Months

############ First try with summarized data: one point per infant per trial (remove complexity of TimeBin)

learning_7_data <- data_time_series_antic %>%
  filter(AOI == "target",
         age_group == "7 months",
         trial_name == "pre-switch_9" | trial_name == "post-switch_1") %>%
  mutate(time_bin_centred = TimeBin - 2) %>%
  group_by(recording_name, trial_name, trial_type, language, SamplesTotal) %>%
  summarize(mean_prop = mean(Prop, na.rm = TRUE))

learning_model_7  <- glmer(mean_prop ~ language * trial_type + (1 | recording_name), data = learning_7_data, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))) 

summary(learning_model_7) #result is as expected (significantly worse scores at test)

########### Next try including TimeBin

learning_7_data2 <- data_time_series_antic %>%
  filter(AOI == "target",
         age_group == "7 months",
         trial_name == "pre-switch_9" | trial_name == "post-switch_1") %>%
  mutate(time_bin_centred = TimeBin - 2)

learning_model_7_2 <- glmer(SamplesInAOI / SamplesTotal ~ language * trial_type * time_bin_centred + (1 | recording_name), data = learning_7_data2, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))) 

summary(learning_model_7_2) #result is still as expected (significantly worse scores at test)



#------------------------------------20 Months

############ First try with summarized data: one point per infant per trial (remove complexity of TimeBin)

learning_20_data <- data_time_series_antic %>%
  filter(AOI == "target",
         age_group == "20 months",
         trial_name == "pre-switch_9" | trial_name == "post-switch_1") %>%
  mutate(time_bin_centred = TimeBin - 2) %>%
  group_by(recording_name, trial_name, trial_type, language, SamplesTotal) %>%
  summarize(mean_prop = mean(Prop, na.rm = TRUE))

learning_model_20  <- glmer(mean_prop ~ language * trial_type + (1 | recording_name), data = learning_20_data, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))) 

summary(learning_model_20) #result is NOT as expected (huge effect, but not significant because the standard error is even larger)

########### Next try including TimeBin

learning_20_data2 <- data_time_series_antic %>%
  filter(AOI == "target",
         age_group == "20 months",
         trial_name == "pre-switch_9" | trial_name == "post-switch_1") %>%
  mutate(time_bin_centred = TimeBin - 2)

learning_model_20_2 <- glmer(SamplesInAOI / SamplesTotal ~ language * trial_type * time_bin_centred + (1 | recording_name), data = learning_20_data2, family = binomial, weights = SamplesTotal, control=glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))) 

summary(learning_model_20_2) #result is still NOT as expected (huge effect, but not significant because the standard error is even larger)

```

##Anovas

###Block data


```{r block_data, echo = FALSE}

###---------------------------------------------------BLOCK DATA----------------------------------

block_data <- data_eyetracking_clean %>%
  make_time_window_data(aois = c("target", "distractor", "circle"),
                        predictor_columns = c("age_group", "language", "trial_type", "trial_num")) %>%
  select(-Elog, -Weights, -LogitAdjusted, -ArcSin) %>%
  mutate(looking_ms = Prop * (SamplesTotal * (1000/60))) %>% #adds number of milliseconds spent looking at target for the trial
  pivot_wider(names_from = AOI, values_from = c(SamplesInAOI, Prop, looking_ms)) %>%
  mutate(total_looking_time = looking_ms_target + looking_ms_distractor + looking_ms_circle) %>%
  mutate(correct = case_when(looking_ms_target > looking_ms_distractor ~ 1, 
                                   TRUE ~ 0),
         incorrect = case_when(looking_ms_target < looking_ms_distractor ~ 1, 
                                     TRUE ~ 0),
         no_anticipation = case_when(looking_ms_target + looking_ms_distractor == 0 ~ 1, 
                              TRUE ~ 0),
         total_anticipation = 1 - no_anticipation) %>% 
  #filter(no_anticipation == 0) %>% ### keep the circle looks!
  mutate(block_num = (as.numeric(trial_num)+2) %/% 3) %>%
  mutate(block_num = as.factor(block_num)) %>%
  group_by(recording_name, language, 
           trial_type, block_num, age_group) %>%
  summarise(num_trials_contributed = length(correct), 
            correct_anticipation = mean(correct, na.rm = TRUE),
            total_anticipation = mean(total_anticipation, na.rm = TRUE)) %>%
  group_by(recording_name, trial_type) %>%
  mutate(n_blocks = length(unique(block_num)))

block_data_means <- block_data %>%
  group_by(language, age_group, trial_type, block_num) %>%
  summarise(correct_anticipation = mean(correct_anticipation), num_trials_contributed = mean(num_trials_contributed))

#---------------------------------------------------check how many we lose who don't have 3 blocks of data---

block_data %>%
  group_by(age_group) %>%
  filter(n_blocks < 3) %>%
  summarize(dropped = length(unique(recording_name)))
  
```

###Anovas 7 m

```{r anovas}
#--------------------------------------------------------------------ANOVA by block: 7m pre-switch

pre_7 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  rename(language_group = language,
         block = block_num) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block,
          between = language_group, 
          detailed = TRUE,
          type = 3)


#-----------------------------------------------------------------make table
apa.ezANOVA.table(pre_7,
                  table.number = 3,
                  correction = "none",
                  table.title = "Mixed ANOVA results for the training phase in Experiment 1 (7-month-olds)",
                  filename = here("figures", "anova_table_pre_7_filtered.doc"))


#--------------------------------------------------------------------Monolingual pre switch

pre_7_mono <-  block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)
#--------------------------------------------------------------------T tests comparing improvement across blocks
pre_7_mono_t_1_2 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 2) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

pre_7_mono_t_1_3 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

pre_7_mono_t_2_3 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 2 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

#--------------------------------------------------------------------Bilingual pre switch

pre_7_bi <-  block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)
#--------------------------------------------------------------------T tests comparing improvement across blocks

pre_7_bi_t_1_2 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 2) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

pre_7_bi_t_1_3 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

pre_7_bi_t_2_3 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 2 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

#-------------------------------------------------------------------- T tests comparing mono to bi for each block

pre_7_t_1 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(block_num == 1) %>%
  t.test(correct_anticipation ~ language, data = .)

pre_7_t_2 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(block_num == 2) %>%
  t.test(correct_anticipation ~ language, data = .)

pre_7_t_3 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(block_num == 3) %>%
  t.test(correct_anticipation ~ language, data = .)


#--------------------------------------------------------------------ANOVA by block: 7m post-switch

post_7 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          between = language, 
          detailed = TRUE,
          type = 3)

apa.ezANOVA.table(post_7,
                  table.number = 3,
                  correction = "none",
                  table.title = "Mixed ANOVA results for the test phase in Experiment 1 (7-month-olds)",
                  filename = here("figures", "anova_table_post_7_filtered.doc"))

#-------------------------------------------------------------------- Monolinguals post switch

post_7_mono <-  block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

block_data %>%
  filter(age_group == "7 months" & trial_type == "post-switch" & n_blocks == 3) %>%
apa.2way.table(iv1 = block_num, 
               iv2 = language,
               dv = correct_anticipation, 
               data = ., 
               show.marginal.means = FALSE,
               filename = here("figures", "means_table_post_7_filtered.doc"), 
               table.number = 4)


#-------------------------------------------------------------------- T tests comparing mono improvement across blocks

post_7_mono_t_1_2 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 2) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

post_7_mono_t_1_3 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

post_7_mono_t_2_3 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 2 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

#-------------------------------------------------------------------- Post switch bi

post_7_bi <-  block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)
#-------------------------------------------------------------------- T tests for bi improvement across blocks


post_7_bi_t_1_2 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 2) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

post_7_bi_t_1_3 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

post_7_bi_t_2_3 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 2 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

#-------------------------------------------------------------------- T tests comparing mono to bi for each block


post_7_t_1 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "post-switch") %>%
  filter(block_num == 1) %>%
  t.test(correct_anticipation ~ language, data = .) 

post_7_t_2 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "post-switch") %>%
  filter(block_num == 2) %>%
  t.test(correct_anticipation ~ language, data = .)

post_7_t_3 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "post-switch") %>%
  filter(block_num == 3) %>%
  t.test(correct_anticipation ~ language, data = .)

t_table_7 <- broom::tidy(post_7_t_1) %>%
  bind_rows(broom::tidy(post_7_t_2)) %>%
  bind_rows(broom::tidy(post_7_t_3)) %>%
  rename(M_mono = estimate1,
         M_bi = estimate2,
         t = statistic,
         df = parameter) %>%
  select(-estimate, -method, -alternative)

#-------------------------------------------------------------------- Any difference in anticipations for 7 months?

pre_7_anticipations <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = total_anticipation,
          wid = recording_name,
          within = block_num,
          between = language, 
          detailed = TRUE,
          type = 3)

post_7_anticipations <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = total_anticipation,
          wid = recording_name,
          within = block_num,
          between = language, 
          detailed = TRUE,
          type = 3)
```

###Anovas 20 m

```{r}

##---------------------------------------------------------------20 month pre switch
## ANOVA by block: 20m pre-switch


pre_20 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          between = language,
          detailed = TRUE,
          type = 3)

#-----------------------------------------------------------------make table
apa.ezANOVA.table(pre_20,
                  table.number = 6,
                  correction = "none",
                  table.title = "Mixed ANOVA results for the training phase in Experiment 2 (20-month-olds)",
                  filename = here("figures", "anova_table_pre_20_filtered.doc"))

pre_20_mono <-  block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

pre_20_bi <-  block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

#--------------------------------------------------------------------T tests comparing improvement across blocks
#monolingual:
pre_20_mono_t_1_2 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 2) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

pre_20_mono_t_1_3 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

pre_20_mono_t_2_3 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 2 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

#bilingual:

pre_20_bi_t_1_2 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 2) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

pre_20_bi_t_1_3 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 1 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

pre_20_bi_t_2_3 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  filter(block_num == 2 | block_num == 3) %>%
  t.test(correct_anticipation ~ block_num, data = ., paired = TRUE)

#-------------------------------------------------------------------- T tests comparing mono to bi for each block

pre_20_t_1 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(block_num == 1) %>%
  t.test(correct_anticipation ~ language, data = .)

pre_20_t_2 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(block_num == 2) %>%
  t.test(correct_anticipation ~ language, data = .)

pre_20_t_3 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(block_num == 3) %>%
  t.test(correct_anticipation ~ language, data = .)
#-----------------------------------------------------------------POST SWITCH 20

## ANOVA by block: 20m post-switch

post_20 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          between = language,
          detailed = TRUE,
          type = 3)

#-----------------------------------------------------------------make table
apa.ezANOVA.table(post_20,
                  table.number = 7,
                  correction = "none",
                  table.title = "Mixed ANOVA results for the Test phase in Experiment 2 (20-month-olds)",
                  filename = here("figures", "anova_table_post_20_filtered.doc"))

post_20_mono <-  block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

post_20_bi <-  block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

```


## Correlation

Check if overall performance correlates across conditions

### Data
```{r}
###----------------------------------------------------Data -----------------
# package for visualization
library("ggpubr")

corr_data <- 
  model_data %>% 
  group_by(trial_type, language, age_group, recording_name) %>% 
  summarise(mean_prop = mean(Prop, na.rm = T)) %>% 
  ungroup() 

# 7
corr_mono_7 <- 
  corr_data %>% 
  filter(language == "Monolinguals", age_group == "7 months") %>% 
  spread(key = trial_type, value = mean_prop) %>%
  rename(postswitch = `post-switch`, preswitch = `pre-switch`)

corr_bi_7 <- 
  corr_data %>% 
  filter(language == "Bilinguals", age_group == "7 months") %>% 
  spread(key = trial_type, value = mean_prop) %>%
  rename(postswitch = `post-switch`, preswitch = `pre-switch`)

# 20
corr_mono_20 <- 
  corr_data %>% 
  filter(language == "Monolinguals", age_group == "20 months") %>% 
  spread(key = trial_type, value = mean_prop) %>%
  rename(postswitch = `post-switch`, preswitch = `pre-switch`)

corr_bi_20 <- 
  corr_data %>% 
  filter(language == "Bilinguals", age_group == "20 months") %>% 
  spread(key = trial_type, value = mean_prop) %>%
  rename(postswitch = `post-switch`, preswitch = `pre-switch`)

###----------------------------------------------------Bilinguals -----------------
# 7-months
# correlations
cor(corr_bi_7$preswitch, corr_bi_7$postswitch, method = "pearson")
cor.test(corr_bi_7$preswitch, corr_bi_7$postswitch, method = "pearson")

# normality assumptions
shapiro.test(corr_bi_7$preswitch) # 0.02
shapiro.test(corr_bi_7$postswitch) # 0.02
ggqqplot(corr_bi_7$preswitch, ylab = "pre-switch")
ggqqplot(corr_bi_7$postswitch, ylab = "post-switch")

# visualization
ggscatter(corr_bi_7, x = "postswitch", y = "preswitch", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "post-switch", ylab = "pre-switch")

# 20-months
# correlations
cor(corr_bi_20$preswitch, corr_bi_20$postswitch, method = "pearson")
cor.test(corr_bi_20$preswitch, corr_bi_20$postswitch, method = "pearson")

# normality assumptions
shapiro.test(corr_bi_20$preswitch) # 0.24
shapiro.test(corr_bi_20$postswitch) # 0.45
ggqqplot(corr_bi_20$preswitch, ylab = "pre-switch")
ggqqplot(corr_bi_20$postswitch, ylab = "post-switch")

# visualization
ggscatter(corr_bi_20, x = "postswitch", y = "preswitch", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "post-switch", ylab = "preswitch")

###----------------------------------------------------Monolinguals -----------------
# 7-months
# correlations
cor(corr_mono_7$preswitch, corr_mono_7$postswitch, method = "pearson")
cor.test(corr_mono_7$preswitch, corr_mono_7$postswitch, method = "pearson")

# normality assumptions
shapiro.test(corr_mono_7$preswitch) # 0.25
shapiro.test(corr_mono_7$postswitch) # 0.000004
ggqqplot(corr_mono_7$preswitch, ylab = "pre-switch")
ggqqplot(corr_mono_7$postswitch, ylab = "post-switch")

# visualization
ggscatter(corr_mono_7, x = "postswitch", y = "preswitch", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "post-switch", ylab = "pre-switch")

# 20-months
# correlations
cor(corr_mono_20$preswitch, corr_mono_20$postswitch, method = "pearson")
cor.test(corr_mono_20$preswitch, corr_mono_20$postswitch, method = "pearson")

# normality assumptions
shapiro.test(corr_mono_20$preswitch) # 0.50
shapiro.test(corr_mono_20$postswitch) # 0.03
ggqqplot(corr_mono_20$preswitch, ylab = "pre-switch")
ggqqplot(corr_mono_20$postswitch, ylab = "post-switch")

# visualization
ggscatter(corr_mono_20, x = "postswitch", y = "preswitch", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "post-switch", ylab = "pre-switch")

```

