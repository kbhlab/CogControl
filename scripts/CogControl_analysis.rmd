---
title: "Cog Control"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

## Replication Analysis Questions
1. Do monolinguals and bilinguals show the same pattern of learning to anticipate the response in the pre-switch phase of the trial?
2. Do bilinguals perform better in the post-switch phase than monolinguals, and if so, at both ages?

## Data

```{r include = FALSE}
## Load packages
library(tidyverse)
library(readxl)
library(stringr)
library(tidyr)
library(ggplot2)
library(car)
library(ez)
library(snakecase)
library(janitor)
library(lme4)
library(effects)
library(emmeans)
library(apaTables)
library(here)
library(eyetrackingR)
options(scipen = 999)

kovacs09 <- "KovÃ¡cs & Mehler 2009"

## Define minimum looking and minimum trial numbers for this study
MIN_LOOK_PROPORTION <- .5
MIN_NUMBER_TRIALS <- 5

## Read tobii data 
tobii_data_order1 <- read_csv(here("data", "2019-10-24_CogControl_tobii_data_ORDER1.csv"), na = "-") %>% 
  mutate(order = "1") %>% 
  filter(X1 != "All Recordings") #order one has target on left during pre-switch
tobii_data_order2 <- read_csv(here("data", "2019-10-24_CogControl_tobii_data_ORDER2.csv"), na = "-") %>% 
  mutate(order = "2") %>% 
  filter(X1 != "All Recordings") #order one has target on right during pre-switch

names(tobii_data_order1)[1] <- "recording_name" #reads in with "X1" as the first column since no value from Tobii
names(tobii_data_order2)[1] <- "recording_name" #reads in with "X1" as the first column since no value from Tobii

## Read in master_subject_list 
ms_list <- read_csv(here("data", "2019_CogControl_MSL.csv"), na = "-") %>%
  separate(lang.group,into = c("language", "group")) %>%
  filter(keeper == 1) 
colnames(ms_list) <- to_snake_case(colnames(ms_list)) #make everything snake case so it's easier to remember variable names

## Merge tobii orders
tobii_data <- bind_rows(tobii_data_order1, tobii_data_order2)
rm(tobii_data_order1, tobii_data_order2) #don't need these anymore since we've just merged them

## Clean tobii data
names(tobii_data) <- gsub("Total Fixation Duration_Test", "Test_", names(tobii_data))
names(tobii_data) <- gsub("Total Fixation Duration_Training", "Training_", names(tobii_data))
names(tobii_data) <- gsub("Circle_Sum", "Circle", names(tobii_data))
names(tobii_data) <- gsub("Target_Sum", "Target", names(tobii_data))
names(tobii_data) <- gsub("Distractor_Sum", "Distractor", names(tobii_data))
tobii_data[is.na(tobii_data)] <- 0
tobii_data$recording_name = as.factor(tobii_data$recording_name)

## Prep MSL data
ms_list <- ms_list %>%  
  mutate(age_group = fct_rev(as.factor(age_group))) %>%
  mutate(language = fct_rev(as.factor(language))) %>%
  mutate(total_vocab_prod = as.numeric(total_vocab_prod)) %>%
  mutate(total_concept_prod = as.numeric(total_concept_prod)) %>%
  mutate(recording_name = as_factor(recording_name)) %>%
  mutate(gender = as.factor(gender)) %>%
  group_by(language) %>%
  mutate(median_by_group = median(total_vocab_prod,na.rm = T)) %>%
  mutate(vocab_group = ifelse(median_by_group > total_vocab_prod,
                              "Low", 
                              "High")) %>%
  mutate(vocab_group = as.factor(vocab_group)) 

## Convert data from wide to long, and then from long to wide
tobii_data_clean <- tobii_data %>%
  gather(AOI, looking_time, Test_1_Circle:Training_9_Target) %>%
  separate(AOI,into = c("trial_type", "trial_number", "AOI")) %>%
  spread(AOI, looking_time) %>%
  
  ## Change to proper variable types and rename variables
  mutate(trial_type = fct_rev(as.factor(trial_type))) %>%
  mutate(trial_number = as.numeric(trial_number)) %>%
  mutate(trial_type = dplyr::recode(trial_type, "Test" = "post-switch", "Training" = "pre-switch")) %>%
  
  ## calculate the total looking time
  mutate(total_looking_time = Circle + Distractor + Target) %>%
  
  ## Determine whether baby was attending during minimum proportion of anticipatory period
  mutate(good_trial = ifelse(total_looking_time >= MIN_LOOK_PROPORTION, "good", "bad")) %>%
  filter(good_trial == "good") %>% 
  group_by(recording_name, trial_type) %>% 
  mutate(num_good_trial = length(recording_name)) %>%
  
  ## Determine whether baby had the minimum number of good trials & only keep babies with data from pre-switch AND post-switch conditions
  filter(num_good_trial >= MIN_NUMBER_TRIALS) %>%
  group_by(recording_name) %>% 
  mutate(good_baby = length(unique(trial_type))) %>%
  filter(good_baby == 2) %>%
  
  ## Categorize trials as correct, incorrect, or no anticipation (the way Kovacs did it)
  mutate(correct_anticipation = ifelse(Target > Distractor, 1, 0)) %>% #trials where baby looked at correct side longer than incorrect side
  mutate(incorrect_anticipation = ifelse(Distractor > Target, 1, 0)) %>% #trials where baby looked at incorrect side longer than correct side
  mutate(no_anticipation = ifelse(Target + Distractor == 0, 1, 0)) %>% #trials where baby doesn't look at target or distractor
  mutate(total_anticipation = 1-no_anticipation) %>% #trials where there is anticipation to either side
  mutate(prop_target_v_distract = Target/(Target+Distractor)) #actual proportion of time spent looking at target vs looks to other side (but not circle)

## Merge tobii data with Master Subject List
trial_data_all <- merge(tobii_data_clean, ms_list, by = "recording_name") #%>% filter(no_anticipation == 0)


## Calculate proportion of correct anticipations by age group, trial type, and trial number - SUMMARY MEANS
proportion_correct_anticipation <- trial_data_all %>%
  group_by(age_group, language, trial_type, trial_number) %>%
  summarise(proportion = mean(correct_anticipation, na.rm = T),
            num_datapoints = length(recording_name))


## Anticipations by block, including only trials with anticipations
block_data <- trial_data_all %>%
  mutate(block_num = (as.numeric(trial_number)+2) %/% 3) %>%
  mutate(block_num = as.factor(block_num)) %>%
  group_by(recording_name, language, 
           trial_type, block_num, age_group) %>%
  rename(cor_anticipation = correct_anticipation) %>%
  summarise(num_trials_contributed = length(cor_anticipation), 
            correct_anticipation = mean(cor_anticipation, na.rm = T),
            total_anticipation = mean(total_anticipation)) %>%
  group_by(recording_name, trial_type) %>%
  mutate(n_blocks = length(unique(block_num)))
 

```

### Number of Keepers in each group
These are the number of infants who contributed at least 500 miliseconds of data for at least 5/9 trials in each condition (both pre-switch and post-switch).
```{r echo = FALSE}
trial_data_all %>%
  group_by(age_group, language) %>%
  summarize(num_participants = n_distinct(recording_name))
```


### Block means by group and trial type (for replication analysis)
We will use these means for the block analysis to follow the `r kovacs09` analysis as closely as possible. These means are the average number of infants for each block who looked more at the target than at the distractor.

```{r echo = FALSE}
block_data %>%
  group_by(language, age_group, trial_type, block_num) %>%
  summarise(correct_anticipation = mean(correct_anticipation), num_trials_contributed = mean(num_trials_contributed))
```


### Explore data visually
#### Histograms by age, language group, and trial type for trials 1 and 9
```{r echo = FALSE, message = FALSE}
library(cowplot)
hist_data <- trial_data_all %>% filter(trial_number == 1 | trial_number == 9) %>% mutate(trial_number = dplyr::recode(trial_number, `1` = "Trial 1", `9` = "Trial 9"))
hist_7_mono <- hist_data %>% filter(age_group == "7 months") %>% filter(language == "Monolinguals") %>%ggplot(., aes(x = prop_target_v_distract)) + 
  geom_histogram() + 
  ylim(0, 15) +
  facet_grid(trial_type ~ trial_number) +
  ggtitle("7 Month Monolinguals")
hist_7_bi <- hist_data %>% filter(age_group == "7 months") %>% filter(language == "Bilinguals") %>%ggplot(., aes(x = prop_target_v_distract)) + 
  geom_histogram() + 
  ylim(0, 15) +
  facet_grid(trial_type ~ trial_number) +
  ggtitle("7 Month Bilinguals")
hist_20_mono <- hist_data %>% filter(age_group == "20 months") %>% filter(language == "Monolinguals") %>%ggplot(., aes(x = prop_target_v_distract)) + 
  geom_histogram() + 
  ylim(0, 15) +
  facet_grid(trial_type ~ trial_number) +
  ggtitle("20 Month Monolinguals")
hist_20_bi <- hist_data %>% filter(age_group == "20 months") %>% filter(language == "Bilinguals") %>%ggplot(., aes(x = prop_target_v_distract)) + 
  geom_histogram() + 
  ylim(0, 15) +
  facet_grid(trial_type ~ trial_number) +
  ggtitle("20 Month Bilinguals")
histograms <- plot_grid(hist_7_mono, hist_7_bi, hist_20_mono, hist_20_bi, labels = "auto", align = "vh", ncol = 2)
histograms
```

A histogram of the proportion data shows that we have a lot of 0s and 1s, and not much in between. Since this data is not normally distributed, we will have to use a nonparametric test (generalized linear mixed effects model) for our own analyses. 

These histograms suggest that by the 9th trial, 7-month-old bilinguals may indeed outperform 7-month-old monolinguals in the post-switch condition, but the pre-switch condition looks pretty similar for both groups. 

At 20 months, it looks like the bilinguals may not have the same advantage in the post-switch condition, although the count of data points post-switch appears to be low. Some infants' data points don't have a valid proportion number for some trials because Target/(Target + Distractor) includes NaNs due to dividing by 0. Let's check how many 'propotion of looking time to target vs distractor' data points we have for each trial.

```{r echo = FALSE}
data_points <- trial_data_all %>%
  group_by(language, age_group, trial_type, trial_number) %>% filter(!is.na(prop_target_v_distract)) %>%
  summarise(num_data_points = n_distinct(recording_name)) %>% arrange(num_data_points)
data_points
```
There are some trials for certain groups that are missing quite a bit of data. The range is `r min(data_points$num_data_points)` data points to `r  max(data_points$num_data_points)` data points. The trials with the lowest number of data points tend to be higher number trials and tend to be in the post-switch condition, suggesting loss of data due to boredom as the study goes on.


#### All data points - plot for proportion of looking time
```{r echo = FALSE}
prop_looking_time_figure <- trial_data_all %>%
  ggplot(aes(x = trial_number, y = prop_target_v_distract, color = language, shape = language, linetype = language)) +
  geom_jitter(alpha = 0.5, height = 0, width = 0.5) +
  facet_grid(age_group ~ trial_type) +
  scale_x_discrete(limits = c(1:9)) +
  scale_y_continuous(limits = c(0:1)) +
  theme_bw(base_size=15) +
  scale_color_manual(values = c("#ff3300", # bilingual colour
                                "#070707")) + # mono colour
  xlab("Trial number") +
  ylab("Proportion of time looking at \n target vs. distractor")

prop_looking_time_figure
```
Again, these plots show a lot of 0 and 1 values, and not a lot in between. In general, it looks like there are fewer 0 values in later trials for both conditions, though this is more pronounced in the pre-switch condition.


#### Means plot - for proportion of infants with correct anticipation per trial

```{r echo = FALSE}
prop_infants_figure <- proportion_correct_anticipation %>%
  ggplot(aes(x = trial_number, y = proportion, color = language, shape = language, linetype = language)) +
  stat_summary(fun.y = "mean", geom = "point") +
  stat_smooth(se = FALSE) +
  facet_grid(age_group ~ trial_type) +
  scale_x_discrete(limits = c(1:9)) +
  scale_y_continuous(limits = c(0:1)) +
  theme_bw(base_size=15) +
  scale_color_manual(values = c("#ff3300", # bilingual colour
                                "#070707")) + # mono colour
  xlab("Trial number") +
  ylab("Proportion of infants with \ncorrect anticipation")

prop_infants_figure
```

From this plot it looks like 20-month-olds are more accurate than 7-month-olds, and that at both ages, the post-switch condition reduces correct anticipation.


#### Blocks figure
```{r echo = FALSE}
blocks_figure <- block_data %>%
  ggplot(aes(x = block_num, y = correct_anticipation, fill = language)) +
  stat_summary(fun.y = "mean", geom = "bar", position = "dodge") +
  facet_grid(age_group ~ trial_type) +
  scale_y_continuous(limits = c(0:1)) +
  theme_bw(base_size=15) +
  scale_fill_manual(values = c("#ff3300", # bilingual colour
                               "#070707")) + # mono colour
  xlab("Block number") +
  ylab("Proportion of infants with \ncorrect anticipation")

blocks_figure
```

Splitting the 9 trials into 3 blocks, we see again that 20-month-olds seem to be more accurate and that the post-switch condition appears to hinder correct anticipation.

#### Any anticipation figure
```{r echo = FALSE}
total_antic_figure <- block_data %>%
  ggplot(aes(x = block_num, y = total_anticipation, fill = language)) +
  stat_summary(fun.y = "mean", geom = "bar", position = "dodge") +
  facet_grid(age_group ~ trial_type) +
  scale_y_continuous(limits = c(0:1)) +
  theme_bw(base_size=15) +
  scale_fill_manual(values = c("#ff3300", # bilingual colour
                               "#070707")) + # mono colour
  xlab("Block number") +
  ylab("Proportion of infants with \nany anticipation")

total_antic_figure
```

This figure suggests that there aren't great differences between monolinguals and bilinguals in total anticipation (looks to both the correct and incorrect side), except for perhaps block 3 post-switch for 7-month-olds and block 2 post-switch for 20-month-olds.

```{r echo = FALSE}
# mean length of any anticipation for each combination of language group/trial type/age group
total_ant_summary <- trial_data_all %>%
  group_by(language, trial_type, age_group) %>%
  summarize(mean_total_ant = mean(total_anticipation, na.rm = TRUE))
total_ant_summary


```
Do monolinguals and bilinguals differ in total anticipation across blocks?

Pre-Switch 7-month-olds
```{r echo = FALSE}

pre_7_total_ant <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = total_anticipation,
          wid = recording_name,
          within = block_num,
          between = language, 
          detailed = TRUE,
          type = 3)

apa.ezANOVA.table(pre_7_total_ant)


```

Post-Switch 7-month-olds
```{r echo = FALSE}


post_7_total_ant <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = total_anticipation,
          wid = recording_name,
          within = block_num,
          between = language, 
          detailed = TRUE,
          type = 3)
apa.ezANOVA.table(post_7_total_ant)
```

Pre-Switch 20-month-olds
```{r echo = FALSE}
pre_20_total_ant <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = total_anticipation,
          wid = recording_name,
          within = block_num,
          between = language, 
          detailed = TRUE,
          type = 3)
apa.ezANOVA.table(pre_20_total_ant)
```

Post-Switch 20-month-olds
```{r echo = FALSE}
post_20_total_ant <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = total_anticipation,
          wid = recording_name,
          within = block_num,
          between = language, 
          detailed = TRUE,
          type = 3)
apa.ezANOVA.table(post_20_total_ant)

```

## Analyses
### Replication analyses

```{r echo = FALSE, message = FALSE}
## ANOVA by block: 7m pre-switch

pre_7 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          between = language, 
          detailed = TRUE,
          type = 3)

pre_7_mono <-  block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

pre_7_bi <-  block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

## ANOVA by block: 7m post-switch

post_7 <- block_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          between = language, 
          detailed = TRUE,
          type = 3)

post_7_mono <-  block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

post_7_bi <-  block_data %>%
  filter(age_group == "7 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

## ANOVA by block: 20m pre-switch

pre_20 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          between = language, 
          detailed = TRUE,
          type = 3)

pre_20_mono <-  block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

pre_20_bi <-  block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "pre-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

## ANOVA by block: 20m post-switch

post_20 <- block_data %>%
  filter(age_group == "20 months") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          between = language, 
          detailed = TRUE,
          type = 3)

post_20_mono <-  block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Monolinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

post_20_bi <-  block_data %>%
  filter(age_group == "20 months") %>%
  filter(language == "Bilinguals") %>%
  filter(trial_type == "post-switch") %>%
  filter(n_blocks == 3) %>%
  ezANOVA(data = ., 
          dv = correct_anticipation,
          wid = recording_name,
          within = block_num,
          detailed = TRUE,
          type = 3)

```
### Anovas
#### Pre-switch 7 (compare language groups by block)
```{r}
library(apaTables)
apa.ezANOVA.table(pre_7)
```
#### Pre-switch 7 monolinguals (compare blocks)
```{r}
apa.ezANOVA.table(pre_7_mono)
```
#### Pre-switch 7 bilinguals (compare blocks)
```{r}
apa.ezANOVA.table(pre_7_bi)
```
#### Post-switch 7 (compare language groups by block)
```{r}
apa.ezANOVA.table(post_7)
```
#### Post-switch 7 monolinguals (compare blocks)
```{r}
apa.ezANOVA.table(post_7_mono)
```
#### Post-switch 7 bilinguals (compare blocks)
```{r}
apa.ezANOVA.table(post_7_bi)
```
#### Pre-switch 20 (compare language groups by block)
```{r}
apa.ezANOVA.table(pre_20)
```
#### Pre-switch 20 monolinguals (compare blocks)
```{r}
apa.ezANOVA.table(pre_20_mono)
```
#### Pre-switch 20 bilinguals (compare blocks)
```{r}
apa.ezANOVA.table(pre_20_bi)
```
#### Post-switch 20 (compare language groups by block)
```{r}
apa.ezANOVA.table(post_20)
```
#### Post-switch 20 monolinguals (compare blocks)
```{r}
apa.ezANOVA.table(post_20_mono)
```
#### Post-switch 20 bilinguals (compare blocks)
```{r}
apa.ezANOVA.table(post_20_bi)
```

The anovas show:

7-month-olds of either language group do not show a difference between block one and block 3 pre-switch, but they do post-switch
Post-switch, 7-month-old bilingual babies have a significant difference between performance in block 1 and block 3 
20-month olds of either language group show an improvement between block 1 and block 3 pre-switch and post-switch
Post-switch, 20-month-old monolinguals perform differently than bilinguals - only bilinguals do significantly better in block 3 than block 1



#### T-tests comparing correct anticipation for Blocks 1 and 3, by trial type, language group, age group
```{r echo = FALSE}
block_data %>%
  filter(block_num !=2) %>%
  group_by(recording_name, age_group, language, trial_type) %>%
  mutate(n_blocks = length(block_num)) %>%
  filter(n_blocks == 2) %>%
  group_by(age_group, language, trial_type) %>%
  do(broom::tidy(t.test(.$correct_anticipation ~ .$block_num, data = ., paired = TRUE))) %>%
  mutate(cohen_d = statistic/sqrt(parameter +1)) %>%
  mutate_if(is.numeric, funs(round(., 3)))
```
These T-tests indicate that only 7-month-old bilingual infants showed a significant difference between block 1 and block 3, in the post-switch condition. However, some nuance is lost with these tests because within block 1, in most groups, there is a steep increase in correct anticipation over the 3 trials that gets averaged out when using block means.



### Generalized Linear Mixed Effects Model

Since our data is not normal and has a lot of 0 and 1 values, we can use a binomial logit link with glmer to build a model.

#### Analysis questions
1. When analyzing proportion of looking time to target (instead of proportion of babies who looked more at target), do we see the same patterns as above? 
2. Does vocabulary size have any effect on 20-month-olds' accuracy?

#### Outcome variable
- Proportion of time spent looking at target vs. distractor (Target/(Target + Distractor)) -- this means we are only including trials with anticipation, unlike in the replication analyses above.

#### Fixed effects
- Language group
- Vocab group
- Age
- trial type (pre- or post-switch)
- trial number (we expect later trials to have better scores than earlier trials)

#### Random effects
- Participant

We want participants to have their own intercepts (and potentially their own slopes?). Best to try the maximal model first and reduce if it doesn't converge. Do we expect any interactions? Trial type and language group could interact (since we've seen that bilinguals might have different response patterns in the post-switch condition). 

Not sure that vocab group would interact with age or language group---we would expect, say, high vocabulary to have the same effect on monolinguals' and bilinguals' performance.

#### Maximum model...do all these variables make sense?

Rachel didn't think I need anything other than recording_name in the random effects side

**prop_target_v_distract ~ language x age_group x trial_type X trial_number + (1 + trial_type | recording_name)** *this model is too complex--we will break it down so each age group has its own model for each trial type*

So let's try:

**prop_target_v_disract ~ langauge x trial_number + (1 | recording_name)** and for the 20-month-olds **prop_target_v_disract ~ langauge x trial_number + vocab_group + (1 | recording_name)**

```{r}

#make proportion data milliseconds instead of seconds so the binomial function will work properly (doesn't like non-integer values) -- WARNING this could be a mistake, since telling the model that the proportions come from milliseconds instead of seconds increases the 'trustworthiness' of the proportions, and completely changes the results of the model when compared to running the exact same model with seconds instead of milliseconds

model_data <- trial_data_all %>% 
  mutate(Target = Target * 1000) %>% 
  mutate(Distractor = Distractor * 1000) %>% 
  mutate(Target_plus_Distractor = Target + Distractor) %>% 
  mutate(prop_for_model = Target/Target_plus_Distractor) %>% 
  #mutate(trial_number = as.factor(trial_number)) %>% don't do this!
  filter(total_anticipation == 1)

model_data_figure <- model_data %>% 
  mutate(trial_number = as.numeric(trial_number)) %>% 
  group_by(age_group, language, trial_type, trial_number) %>%
  summarise(prop_for_model = mean(prop_for_model, na.rm = T)) %>%
  ggplot(aes(x = trial_number, y = prop_for_model, color = language, shape = language, linetype = language)) +
  stat_summary(fun.y = "mean", geom = "point") +
  stat_smooth(se = FALSE) +
  facet_grid(age_group ~ trial_type) +
  scale_x_discrete(limits = c(1:9)) +
  scale_y_continuous(limits = c(0:1)) +
  theme_bw(base_size=15) +
  scale_color_manual(values = c("#ff3300", # bilingual colour
                                "#070707")) + # mono colour
  ggtitle("Data used for glmer model \n(proportion of looking time)") +
  xlab("Trial number") +
  ylab("Proportion of time spent looking at \ntarget v distractor") 

prop_infants_figure <- prop_infants_figure + ggtitle("Data used for replication analysis \n(proportion of babies looking more at target)")

plot_grid(model_data_figure, prop_infants_figure, labels = "auto", nrow = 2)


```


This was the first model we ran: 

```{r}


model1 <- glmer(prop_for_model ~ language * age_group * trial_type + (1 | recording_name), data = model_data, weights = Target_plus_Distractor, family = "binomial")
summary(model1)

plot(allEffects(model1))

plot(predictorEffects(model1))

emmeans(model1, pairwise ~ age_group)

emmeans(model1, pairwise ~ age_group:language|trial_type)

emmeans(model1, pairwise ~ age_group:trial_type|language)

```

The emmeans plots indicate that bilinguals do worse than monolinguals pre-switch at both ages and better than monolinguals post-switch at both ages. Monolinguals have a much steeper drop between pre- and post-switch trial types than do bilinguals, where the slope is fairly flat between trial types. Age appears to have a similar effect across the board (performance increases about the same for monolinguals/bilinguals).


Next we tried another model for only 7-month-olds that included trial number, but this one has problems:

```{r}
model_data_7 <- model_data %>% filter(age_group == "7 months")

model2 <- glmer(prop_for_model ~ language * trial_type * trial_number + (1 | recording_name), data = model_data_7, weights = Target_plus_Distractor, family = "binomial", control=glmerControl(optimizer="bobyqa",
            optCtrl=list(maxfun=100000)))
summary(model2)

emmeans(model2, pairwise ~ trial_number)
emmeans(model2, pairwise ~ language:trial_type)


```

The above are my first attempts at building suitable models. Model 1 includes both age groups, but cannot coverge with the effect of trial number included. We can split the data into 2 sets (one for each age group) and then include trial number as an effect, but the model kind of breaks. 

After discussing with Krista, we decided to break it down by age group and trial type, so that we can include trial number as a predictor (since we expect that higher trial numbers will have higher scores overall). 

Here is an attempt to run a model for just the 7-month-olds in the pre-switch condition, and again we run into some problems. I noticed that when I run this model using milliseconds as the "weights", everything is significant. But when I run the same model using seconds as "weights", the model is "singular" and nothing is significant. 

After reading up on this, it appears that telling the model that the proportions come from milliseconds instead of seconds increases the 'trustworthiness' of the proportions, and completely changes the results of the model--I am not sure which is the correct measurement to use. This issue makes me wonder whether the glmm is actually correct to use in this case, since the calculated proportion of time spent looking at a target over a distractor doesn't come from a true binomial success/failure situation, where each "trial" is meant to be independent. It also doesn't account for the correlation of datapoints that are close together in time -- see https://link.springer.com/article/10.1007%2Fs11336-018-9604-2

```{r}

#model using milliseconds

model_data_7pre <- model_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch")


model_7pre <- glmer((Target / Target_plus_Distractor) ~ language * trial_number + (1 | recording_name), data = model_data_7pre, weights = Target_plus_Distractor, family = "binomial")
summary(model_7pre)


#model using seconds
model_data_7pre_s <- model_data %>%
  filter(age_group == "7 months") %>%
  filter(trial_type == "pre-switch") %>%
  mutate(Target = Target / 1000) %>% 
  mutate(Distractor = Distractor / 1000) %>%
  mutate(Target_plus_Distractor = Target + Distractor)


model_7pre_s <- glmer((Target / Target_plus_Distractor) ~ language * trial_number + (1 | recording_name), data = model_data_7pre_s, weights = Target_plus_Distractor, family = "binomial")
summary(model_7pre_s)

```


#Full Time Series Data - trying to make figures like in http://rpubs.com/mcfrank/mb2-pilot


```{r echo = FALSE}
#this code is mostly copied from the rpubs link above, to try to get a similar graph
load(here("data", "tobii_ts_data.Rda"))

proportion_trials <- inner_join(tobii_ts_data, ms_list, by = "recording_name") %>%
  mutate(recording_name = as.factor(recording_name))

proportion_summary <- proportion_trials %>%
  filter(target + distractor == 1) %>%
  group_by(trial_type, language, ts_rescaled, trial_num) %>%
  summarise(target = mean(target, na.rm = TRUE),
            distractor = mean(distractor, na.rm = TRUE)) %>%
  mutate(proportion_to_target = target / (target + distractor)) %>%
  gather(region, looking, target, distractor) 


ggplot(proportion_summary, aes(x = ts_rescaled, y = looking, color = region)) + 
  geom_point() +
  facet_grid(trial_num ~ trial_type)

```

Well, that did not work well. The output from Tobii doesn't have a consistent frame rate (sometimes it's 16 ms between each row, sometimes it's 17 or 18), and the timestamps are also not always the same time difference from the beginning of each trial. 



#STARTING FROM RAW TOBII DATA...

Load in and clean full, time-series data from Tobii. (This script has saved the Tobii data as a .RDA file to save time)
```{r echo = FALSE}
#tobii_full_export <- read_tsv(here("data", "tobii_2019-12-18.tsv"),
#                                   col_types = cols(LocalTimeStamp = col_character()))

#save(tobii_full_export, file = here("data", "tobii_full_export.Rda"))

load(here("data", "tobii_full_export.Rda"))

 tobii_full_cleaned <- tobii_full_export %>%
   #head(n = 2500) %>% # uncomment this line to test code changes on a subset of the full dataset since running the whole thing takes ages!
   select(StudioTestName, RecordingName, RecordingDuration, MediaName, RecordingTimestamp, StudioEvent, FixationIndex, GazeEventType, GazeEventDuration, `AOI[Target]Hit`:`AOI[Circle]Hit_35`, `GazePointX (ADCSpx)`, `GazePointY (ADCSpx)`, ValidityLeft, ValidityRight) %>%
      mutate(RecordingName = case_when(RecordingName == "Cogcontrol20_S116_48375" ~ "CogControl20_S116_48375",
                                    RecordingName != "Cogcontrol20_S116_48375" ~ RecordingName)) %>% #fix typo from Tobii
   mutate(circle = rowSums(.[grep("Circle", names(.))], na.rm = TRUE), #collapse all 36 AOI columns into one
          target = rowSums(.[grep("Target", names(.))], na.rm = TRUE), #collapse all 36 AOI columns into one
          distractor = rowSums(.[grep("Distractor", names(.))], na.rm = TRUE)) %>% #collapse all 36 AOI columns into one
   select(-(`AOI[Target]Hit`:`AOI[Circle]Hit_35`)) %>% #get rid of unneeded AOI columns now
   rename(gaze_point_X = `GazePointX (ADCSpx)`, gaze_point_y = `GazePointY (ADCSpx)`, timestamp = `RecordingTimestamp`, order = StudioTestName) %>% #fix names (newname = oldname)
  mutate(MediaName = gsub(".wmv", "", MediaName)) %>% # Drops the .wmv part.
   mutate(trial_num = parse_number(MediaName)) %>% #get trial number
   mutate(trial_type = case_when(str_detect(MediaName, "Training") ~ "pre-switch", #get trial type
                                 str_detect(MediaName, "Test") ~ "post-switch")) %>% #get trial type
   mutate(trial_name = str_c(trial_type, trial_num, sep = "_")) %>%
   mutate(trial_unique = str_c(RecordingName, MediaName, sep = "_")) %>%
   group_by(RecordingName) %>%
   mutate(run_length_id = data.table::rleid(trial_unique)) %>%
   ungroup() %>%
  filter(!is.na(ValidityLeft) & !is.na(ValidityRight)) %>% #gets rid of blippy rows that duplicate some info and don't have meaningful validity data or gaze point info
  filter(RecordingName != "test") %>% #gets rid of a "test" recording that somehow got exported
   mutate(trackloss = case_when(is.na(gaze_point_X) ~ TRUE,
                                is.na(gaze_point_y) ~ TRUE,
                                ValidityLeft > 1 & ValidityRight > 1 ~ TRUE,
                                TRUE ~ FALSE)) %>%
   mutate(MediaName = as.factor(MediaName)) %>%
  #make target aoi coordinates
   mutate(aoi_target_x_left = case_when(order == "Order 1" & trial_type == "pre-switch" ~ 10,
                                        order == "Order 1" & trial_type == "post-switch" ~ 1260,
                                        order == "Order 2" & trial_type == "pre-switch" ~ 1260,
                                        order == "Order 2" & trial_type == "post-switch" ~ 10)) %>%
  mutate(aoi_target_x_length = case_when(!is.na(trial_type) ~ 645)) %>%
  mutate(aoi_target_x_right = aoi_target_x_left + aoi_target_x_length) %>%
  mutate(aoi_target_y_top = case_when(!is.na(trial_type) ~ 270)) %>%
  mutate(aoi_target_y_length = case_when(!is.na(trial_type) ~ 650)) %>%
  mutate(aoi_target_y_bottom = aoi_target_y_top + aoi_target_y_length) %>%
  #make distractor aoi coordinates
  mutate(aoi_distractor_x_left = case_when(order == "Order 1" & trial_type == "pre-switch" ~ 1260,
                                        order == "Order 1" & trial_type == "post-switch" ~ 10,
                                        order == "Order 2" & trial_type == "pre-switch" ~ 10,
                                        order == "Order 2" & trial_type == "post-switch" ~ 1260)) %>%
  mutate(aoi_distractor_x_length = case_when(!is.na(trial_type) ~ 645)) %>%
  mutate(aoi_distractor_x_right = aoi_distractor_x_left + aoi_distractor_x_length) %>%
  mutate(aoi_distractor_y_top = case_when(!is.na(trial_type) ~ 270)) %>%
  mutate(aoi_distractor_y_length = case_when(!is.na(trial_type) ~ 650)) %>%
  mutate(aoi_distractor_y_bottom = aoi_distractor_y_top + aoi_distractor_y_length) %>%
  #make circle aoi coordinates
  mutate(aoi_circle_x_left = case_when(!is.na(trial_type) ~ 758)) %>%
  mutate(aoi_circle_x_length = case_when(!is.na(trial_type) ~ 385)) %>%
  mutate(aoi_circle_x_right = case_when(!is.na(trial_type) ~ aoi_circle_x_left + aoi_circle_x_length)) %>%  
  mutate(aoi_circle_y_top = case_when(!is.na(trial_type) ~ 400)) %>%
  mutate(aoi_circle_y_length = case_when(!is.na(trial_type) ~ 385)) %>%
  mutate(aoi_circle_y_bottom = case_when(!is.na(trial_type) ~ aoi_circle_x_left + aoi_circle_x_length)) %>%  
  clean_names() %>%
  filter(!is.na(media_name)) %>% #remove lines with no media name
  filter(!is.na(trial_unique)) %>% #remove NA unique trials (gets rid of times outside our trial windows)
  filter(is.na(studio_event)) %>% #get rid of MovieStart and MovieEnd lines since they have duplicate timestamps
  mutate(remove_row = case_when(timestamp == 66398 & trial_unique == "CogControl20_S01_42270_Test_Target_Right_4.wmv" & is.na(validity_left) ~ "remove",
                                timestamp == 85782 & trial_unique == "CogControl20_S01_42270_Test_Target_Right_7.wmv" & is.na(validity_left) ~ "remove",
                                timestamp == 35816 & trial_unique == "CogControl7_S24_44771_Training_Target_Left_7.wmv" & is.na(validity_left) ~ "remove",
                                TRUE ~ "keep"))%>% #this identifies 3 rows with duplicate timestamps, but inexplicably without the fixation gaze data, that are preventing the eyetrackingR code from running correctly
  filter(remove_row == "keep") %>% #get rid of those 3 weird rows
  group_by(trial_unique) %>%
  #make time stamps start from 0 for each trial
  mutate(trial_start = min(timestamp)) %>%
  mutate(trial_end = max(timestamp)) %>%
  mutate(trial_from_zero = timestamp - trial_start) %>%
  mutate(gaze_data_length = trial_from_zero - lag(trial_from_zero, default = 0)) %>%
  ungroup() %>%
  #get AOI look per time point
  mutate(look_target = case_when(gaze_point_x > aoi_target_x_left & gaze_point_x < aoi_target_x_right & gaze_point_y > aoi_target_y_top & gaze_point_y < aoi_target_y_bottom ~ 1,
                                 TRUE ~ 0)) %>%
  mutate(look_distractor = case_when(gaze_point_x > aoi_distractor_x_left & gaze_point_x < aoi_distractor_x_right & gaze_point_y > aoi_distractor_y_top & gaze_point_y < aoi_distractor_y_bottom ~ 1,
                                 TRUE ~ 0)) %>%
  mutate(look_circle = case_when(gaze_point_x > aoi_circle_x_left & gaze_point_x < aoi_circle_x_right & gaze_point_y > aoi_circle_y_top & gaze_point_y < aoi_circle_y_bottom ~ 1,
                                 TRUE ~ 0)) %>%
  mutate(look_any = case_when(look_target == 1 | look_distractor == 1 | look_circle == 1 ~ 1,
                              TRUE ~ 0))
  
    
          

save(tobii_full_cleaned, file = here("data", "tobii_full_cleaned.Rda"))

#load(here("data", "tobii_full_cleaned.Rda"))

full_data_merged <- inner_join(tobii_full_cleaned, ms_list, by = "recording_name") %>%
  mutate(recording_name = as.factor(recording_name))






proportion_trials <- full_data_merged %>% 
  group_by(recording_name, trial_name, language, trial_type, age_group, vocab_group, total_vocab_prod) %>%
  summarize(target_ms = sum(target * gaze_event_duration),
            distractor_ms = sum(distractor * gaze_event_duration),
            circle_ms = sum(circle * gaze_event_duration)) %>%
  mutate(total_ms = target_ms + distractor_ms + circle_ms)



##full_data_anticipation_period <- proportion_trials %>% 

```
Use eyetrackingR to get time bins to try to make a better graphic like M. Frank's...

```{r echo = FALSE}



  
 


eyetracking_data <- make_eyetrackingr_data(full_data_merged, 
                               participant_column = "recording_name",
                               trial_column = "trial_name",
                               time_column = "trial_from_zero",
                               trackloss_column = "trackloss",
                               aoi_columns = c('target', 'circle', 'distractor'),
                               treat_non_aoi_looks_as_missing = TRUE)


response_window <- subset_by_window(eyetracking_data,
                                    window_start_time = 2150,
                                    window_end_time = 3150, rezero = TRUE, remove = TRUE)

time_series_data <- make_time_sequence_data(response_window,
                                         time_bin_size = 50,
                                         predictor_columns = c("language", "age_group", "vocab_group", "trial_type", "trial_num"),
                                         aois = c("target", "distractor"))

plot1 <- plot(time_series_data, predictor_column = "age_group")

plot1


time_series_summary <- time_series_data %>%
  group_by(trial_type, language, time, trial_num) %>%
  summarise(target = mean(aoi == "target", na.rm=TRUE),
            distractor = mean(aoi == "distractor", na.rm=TRUE)) %>%
  mutate(proportion_to_target = target / (target + distractor)) %>%
  gather(region, looking, target, distractor) 


ggplot(proportion_summary, aes(x = ts_rescaled, y = looking, color = region)) + 
  geom_point() +
  facet_grid(trial_num ~ trial_type)

```


(this takes ages to run from scratch, so I've commented it out and saved the final dataset as a .Rda object to load in)

```{r echo = FALSE}
#huge_data <- read_tsv(here("data", "2019-12-16_tobii_ts_data.tsv")) 

```

```{r echo = FALSE}
#huge_data_cleaned <- huge_data %>%
# huge_data_shortened <- huge_data %>% head(n = 25000) %>%
#   select(-X118) %>%
#   pivot_longer(10:117, names_to = "AOI", values_to = "looking") %>%
#   mutate(AOI = case_when(grepl("Target", AOI) ~ "Target",
#          grepl("Circle", AOI) ~ "Circle",
#          grepl("Distractor", AOI) ~ "Distractor")) %>%
#   filter(!is.na(looking)) %>%
#   mutate(looking = as.numeric(looking)) %>%
#   pivot_wider(names_from = "AOI", values_from = "looking") %>%
#   separate(SegmentName, into = c("segment", "trial_num")) %>%
#   mutate(trial_num = as.numeric(trial_num)) %>%
#   mutate(trial_type = case_when(trial_num <= 9 ~ "pre-switch",
#                                 trial_num >= 10 ~ "post-switch")) %>%
#   select(-segment) %>%
#   mutate(ts_rescaled = RecordingTimestamp - SegmentStart) %>%
#   mutate(trial_num = case_when(trial_num >= 10 ~ trial_num - 9,
#                                trial_num <= 9 ~ trial_num)) %>%
#   mutate(RecordingName = case_when(RecordingName == "Cogcontrol20_S116_48375" ~ "CogControl20_S116_48375",
#                                     RecordingName != "Cogcontrol20_S116_48375" ~ RecordingName)) %>%
#   select(RecordingName, trial_num, trial_type, ts_rescaled, Target, Circle, Distractor, SegmentStart, SegmentEnd, SegmentDuration, RecordingTimestamp, RecordingDuration)
# colnames(huge_data_cleaned) <- to_snake_case(colnames(huge_data_cleaned))
# huge_data_cleaned <- huge_data_cleaned %>% mutate(recording_name = as.factor(recording_name))
# save(huge_data_shortened, file = "./huge_data_shortened.Rda")

#load(here("data", "tobii_ts_data.Rda"))


#proportion_trials <- inner_join(tobii_ts_data, ms_list, by = "recording_name") %>% 
#  mutate(recording_name = as.factor(recording_name)) %>%
#  filter(trial_num <= 9) # S14 from CogControl 20 was exported from Tobii with duplicate segments and so we need to remove these

```
